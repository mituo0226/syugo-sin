<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>æ±ºæ¸ˆãƒ†ã‚¹ãƒˆ - å®ˆè­·ç¥å ã„</title>
  <meta name="description" content="æ±ºæ¸ˆãƒ•ãƒ­ãƒ¼ã®ãƒ†ã‚¹ãƒˆç”¨ãƒšãƒ¼ã‚¸">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover, maximum-scale=1.0, minimum-scale=1.0">
  <link rel="stylesheet" href="payment-ticket.css">
  <style>
    /* ãƒ†ã‚¹ãƒˆç”¨ã®è¿½åŠ ã‚¹ã‚¿ã‚¤ãƒ« */
    .test-header {
      background: linear-gradient(135deg, #ff6b6b, #ee5a52);
      color: #fff;
      padding: 15px;
      text-align: center;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
    }
    
    .test-info {
      background: rgba(255, 193, 7, 0.1);
      border: 2px solid rgba(255, 193, 7, 0.3);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      color: #ffc107;
    }
    
    .test-info h3 {
      margin: 0 0 10px 0;
      color: #ffc107;
    }
    
    .test-info p {
      margin: 5px 0;
      font-size: 14px;
    }
    
    .localstorage-status {
      background: rgba(102, 204, 255, 0.1);
      border: 1px solid rgba(102, 204, 255, 0.3);
      border-radius: 8px;
      padding: 10px;
      margin: 10px 0;
      font-size: 12px;
      color: #66ccff;
    }
    
    .setup-buttons {
      display: flex;
      gap: 10px;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    
    .setup-button {
      padding: 10px 15px;
      background: linear-gradient(90deg, #9d4edd, #7b2cbf);
      border: none;
      border-radius: 8px;
      color: #fff;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
    }
    
    .setup-button:hover {
      background: linear-gradient(90deg, #b565f0, #9d4edd);
      transform: translateY(-2px);
    }
    
    .setup-button.secondary {
      background: linear-gradient(90deg, #66ccff, #3399ff);
    }
    
    .setup-button.secondary:hover {
      background: linear-gradient(90deg, #99e0ff, #66ccff);
    }
  </style>
</head>
<body>
  <!-- ç¥ç§˜çš„ãªèƒŒæ™¯ -->
  <div class="mystical-bg"></div>
  
  <!-- æµ®éŠã™ã‚‹ç²’å­ -->
  <div class="floating-particles">
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
  </div>

  <div class="container">
    <div class="main-content show">
      <!-- ãƒ†ã‚¹ãƒˆç”¨ãƒ˜ãƒƒãƒ€ãƒ¼ -->
      <div class="test-header">
        <h1>ğŸ§ª æ±ºæ¸ˆãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸</h1>
        <p>æ±ºæ¸ˆãƒ•ãƒ­ãƒ¼ã‹ã‚‰ãƒãƒ£ãƒƒãƒˆãƒšãƒ¼ã‚¸ã¸ã®é·ç§»ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™</p>
      </div>
      
      <!-- ãƒ†ã‚¹ãƒˆæƒ…å ± -->
      <div class="test-info">
        <h3>ğŸ“‹ ãƒ†ã‚¹ãƒˆè¨­å®šæƒ…å ±</h3>
        <p><strong>ç”Ÿå¹´æœˆæ—¥:</strong> 1962å¹´2æœˆ26æ—¥</p>
        <p><strong>å®ˆè­·ç¥:</strong> è™šç©ºè”µè©è–©</p>
        <p><strong>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ :</strong> ã¿ã¤ãŠ</p>
        <p><strong>èˆˆå‘³ã‚ã‚‹ç›¸è«‡:</strong> æ‹æ„›</p>
      </div>
      
      <!-- ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸çŠ¶æ…‹ -->
      <div class="localstorage-status" id="localStorageStatus">
        <strong>ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸çŠ¶æ…‹:</strong> ç¢ºèªä¸­...
      </div>
      
      <!-- ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒœã‚¿ãƒ³ -->
      <div class="setup-buttons">
        <button class="setup-button" onclick="setupTestData()">ğŸ§ª ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š</button>
        <button class="setup-button secondary" onclick="clearAllData()">ğŸ—‘ï¸ ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢</button>
        <button class="setup-button secondary" onclick="checkLocalStorage()">ğŸ” çŠ¶æ…‹ç¢ºèª</button>
      </div>
      
      <!-- ã‚¿ã‚¤ãƒˆãƒ« -->
      <h1 class="title">ä½“é¨“ãƒã‚±ãƒƒãƒˆè³¼å…¥</h1>
      
      <!-- åˆå›é™å®šãƒãƒƒã‚¸ -->
      <div class="first-time-badge">
        <div class="badge-content">
          <span class="badge-icon">âœ¨</span>
          <span class="badge-text">åˆå›é™å®š</span>
        </div>
      </div>
      
      <!-- ãƒã‚±ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ -->
      <div class="ticket-card">
        <div class="ticket-header">
          <h2 class="ticket-title">ä½“é¨“ãƒã‚±ãƒƒãƒˆ</h2>
          <div class="ticket-price">
            <span class="price-amount">100å††</span>
            <span class="price-period">5åˆ†é–“</span>
          </div>
        </div>
        
        <div class="ticket-description">
          <p class="main-description">ã¾ãšã¯ä½“é¨“ã‹ã‚‰ã€‚100å††ã§5åˆ†é–“ã€å®ˆè­·ç¥ã‚„é¾ã¨ã¤ãªãŒã‚Œã¾ã™</p>
          <p class="sub-description">ç¥ç§˜çš„ãªé‘‘å®šä½“é¨“ã‚’æ°—è»½ã«ãŠè©¦ã—ãã ã•ã„</p>
        </div>
        
        <div class="ticket-features">
          <div class="feature-item">
            <span class="feature-icon">ğŸ”®</span>
            <span class="feature-text">å®ˆè­·ç¥ã¨ã®å¯¾è©±</span>
          </div>
          <div class="feature-item">
            <span class="feature-icon">ğŸ‰</span>
            <span class="feature-text">é¾ã®å°ã</span>
          </div>
          <div class="feature-item">
            <span class="feature-icon">âœ¨</span>
            <span class="feature-text">ç¥ç§˜çš„ãªé‘‘å®š</span>
          </div>
        </div>
      </div>
      
      <!-- æ±ºæ¸ˆãƒ•ã‚©ãƒ¼ãƒ  -->
      <div class="payment-form-container">
        <h3 class="form-title">æ±ºæ¸ˆæƒ…å ±</h3>
        
        <form id="paymentForm" class="payment-form">
          <div class="form-group">
            <label for="cardNumber">ã‚«ãƒ¼ãƒ‰ç•ªå·</label>
            <div class="input-wrapper">
              <input type="text" id="cardNumber" name="cardNumber" placeholder="4111 1111 1111 1111" maxlength="19" required>
              <span class="input-icon">ğŸ’³</span>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="expiryDate">æœ‰åŠ¹æœŸé™</label>
              <div class="input-wrapper">
                <input type="text" id="expiryDate" name="expiryDate" placeholder="MM/YY" maxlength="5" required>
                <span class="input-icon">ğŸ“…</span>
              </div>
            </div>
            
            <div class="form-group">
              <label for="cvv">CVC</label>
              <div class="input-wrapper">
                <input type="text" id="cvv" name="cvv" placeholder="111" maxlength="4" required>
                <span class="input-icon">ğŸ”’</span>
              </div>
            </div>
          </div>
          
          <div class="form-group">
            <label for="postalCode">éƒµä¾¿ç•ªå·</label>
            <div class="input-wrapper">
              <input type="text" id="postalCode" name="postalCode" placeholder="12345" maxlength="10" required>
              <span class="input-icon">ğŸ </span>
            </div>
          </div>
          
          <!-- ãƒ†ã‚¹ãƒˆæƒ…å ± -->
          <div class="test-info">
            <h4>ãƒ†ã‚¹ãƒˆç”¨ã‚«ãƒ¼ãƒ‰æƒ…å ±</h4>
            <div class="test-info-grid">
              <div class="test-item">
                <span class="test-label">ã‚«ãƒ¼ãƒ‰ç•ªå·:</span>
                <span class="test-value">4111 1111 1111 1111</span>
              </div>
              <div class="test-item">
                <span class="test-label">æœ‰åŠ¹æœŸé™:</span>
                <span class="test-value">12/25</span>
              </div>
              <div class="test-item">
                <span class="test-label">CVC:</span>
                <span class="test-value">111</span>
              </div>
              <div class="test-item">
                <span class="test-label">éƒµä¾¿ç•ªå·:</span>
                <span class="test-value">12345</span>
              </div>
            </div>
          </div>
          
          <button type="submit" class="payment-button" id="paymentButton">
            <span class="button-icon">âœ¨</span>
            <span class="button-text">100å††ã§ä½“é¨“ã‚’é–‹å§‹</span>
            <span class="button-subtext">5åˆ†é–“ã®ç¥ç§˜çš„ãªé‘‘å®š</span>
          </button>
        </form>
      </div>
      
      <!-- æ³¨æ„äº‹é … -->
      <div class="notice">
        <h4>ã”åˆ©ç”¨ä¸Šã®æ³¨æ„</h4>
        <ul>
          <li>æ±ºæ¸ˆã¯å®‰å…¨ãªSquareæ±ºæ¸ˆã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™</li>
          <li>ä½“é¨“ãƒã‚±ãƒƒãƒˆã¯è³¼å…¥å¾Œã€å³åº§ã«ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™</li>
          <li>5åˆ†é–“ã®é‘‘å®šæ™‚é–“ãŒä»˜ä¸ã•ã‚Œã¾ã™</li>
          <li>æ±ºæ¸ˆå®Œäº†å¾Œã€è‡ªå‹•çš„ã«ãƒãƒ£ãƒƒãƒˆãƒšãƒ¼ã‚¸ã«é·ç§»ã—ã¾ã™</li>
        </ul>
      </div>
      
      <!-- æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
      <div class="back-section">
        <a href="./index.html" class="back-button">ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a>
        <a href="./test-chat.html" class="back-button" style="margin-left: 10px;">ãƒãƒ£ãƒƒãƒˆãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸ã¸</a>
      </div>
    </div>
  </div>

  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <h3>æ±ºæ¸ˆå‡¦ç†ä¸­...</h3>
      <p>é¾ãŒã‚ãªãŸã®é‹å‘½ã‚’ç…§ã‚‰ã—ã¦ã„ã¾ã™</p>
    </div>
  </div>

  <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
  <div class="error-message" id="errorMessage">
    <div class="error-content">
      <span class="error-icon">âš ï¸</span>
      <span class="error-text" id="errorText"></span>
      <button class="error-close" onclick="hideError()">Ã—</button>
    </div>
  </div>

  <script>
    // ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿
    const testUserData = {
      nickname: 'ã¿ã¤ãŠ',
      year: 1962,
      month: 2,
      day: 26,
      guardian: 'è™šç©ºè”µè©è–©',
      guardianKey: 'kokuzou',
      worry: 'æ‹æ„›',
      question: 'æ‹æ„›'
    };
    
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
    window.addEventListener('load', function() {
      console.log('æ±ºæ¸ˆãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
      
      // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º
      setTimeout(() => {
        const mainContent = document.getElementById('mainContent');
        mainContent.classList.add('show');
      }, 500);
      
      // ãƒ•ã‚©ãƒ¼ãƒ ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
      setupFormEventListeners();
      
      // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸çŠ¶æ…‹ã‚’ç¢ºèª
      checkLocalStorage();
      
      // UIDã‚’ç”Ÿæˆ
      const uid = generateUID();
      localStorage.setItem('currentUID', uid);
      console.log('ãƒ†ã‚¹ãƒˆç”¨UIDã‚’ç”Ÿæˆ:', uid);
    });
    
    // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
    function setupTestData() {
      try {
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
        localStorage.setItem('userData', JSON.stringify(testUserData));
        
        // æ—¢å­˜ã®ãƒã‚±ãƒƒãƒˆæƒ…å ±ã‚’ã‚¯ãƒªã‚¢
        localStorage.removeItem('selectedTicket');
        localStorage.removeItem('expireAt');
        
        console.log('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®šã—ã¾ã—ãŸ:', testUserData);
        showMessage('âœ… ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®šã—ã¾ã—ãŸ', 'success');
        checkLocalStorage();
        
      } catch (error) {
        console.error('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿è¨­å®šã‚¨ãƒ©ãƒ¼:', error);
        showMessage('âŒ ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®è¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      }
    }
    
    // å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
    function clearAllData() {
      try {
        localStorage.clear();
        console.log('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
        showMessage('ğŸ—‘ï¸ å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'info');
        checkLocalStorage();
        
      } catch (error) {
        console.error('ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼:', error);
        showMessage('âŒ ãƒ‡ãƒ¼ã‚¿ã®ã‚¯ãƒªã‚¢ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      }
    }
    
    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸çŠ¶æ…‹ã‚’ç¢ºèª
    function checkLocalStorage() {
      const statusDiv = document.getElementById('localStorageStatus');
      
      try {
        const userData = localStorage.getItem('userData');
        const selectedTicket = localStorage.getItem('selectedTicket');
        const expireAt = localStorage.getItem('expireAt');
        const currentUID = localStorage.getItem('currentUID');
        
        let status = '<strong>ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸çŠ¶æ…‹:</strong><br>';
        
        if (userData) {
          const parsed = JSON.parse(userData);
          status += `âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿: ${parsed.nickname} (${parsed.year}/${parsed.month}/${parsed.day})<br>`;
        } else {
          status += 'âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿: æœªè¨­å®š<br>';
        }
        
        if (selectedTicket) {
          const parsed = JSON.parse(selectedTicket);
          status += `âœ… é¸æŠãƒã‚±ãƒƒãƒˆ: ${parsed.name} (${parsed.minutes}åˆ†)<br>`;
        } else {
          status += 'âŒ é¸æŠãƒã‚±ãƒƒãƒˆ: æœªè¨­å®š<br>';
        }
        
        if (expireAt) {
          status += `âœ… æœ‰åŠ¹æœŸé™: ${expireAt}<br>`;
        } else {
          status += 'âŒ æœ‰åŠ¹æœŸé™: æœªè¨­å®š<br>';
        }
        
        if (currentUID) {
          status += `âœ… UID: ${currentUID}<br>`;
        } else {
          status += 'âŒ UID: æœªè¨­å®š<br>';
        }
        
        statusDiv.innerHTML = status;
        
      } catch (error) {
        statusDiv.innerHTML = '<strong>ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸çŠ¶æ…‹:</strong> âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
        console.error('ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
      }
    }
    
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
    function showMessage(message, type = 'info') {
      const errorDiv = document.getElementById('errorMessage');
      const errorText = document.getElementById('errorText');
      
      errorText.textContent = message;
      errorDiv.classList.add('show');
      
      // 3ç§’å¾Œã«è‡ªå‹•ã§éè¡¨ç¤º
      setTimeout(() => {
        hideError();
      }, 3000);
    }
    
    // ã‚¨ãƒ©ãƒ¼éè¡¨ç¤º
    function hideError() {
      const errorMessage = document.getElementById('errorMessage');
      errorMessage.classList.remove('show');
    }
    
    // ãƒ•ã‚©ãƒ¼ãƒ ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    function setupFormEventListeners() {
      const form = document.getElementById('paymentForm');
      const cardNumber = document.getElementById('cardNumber');
      const expiryDate = document.getElementById('expiryDate');
      const cvv = document.getElementById('cvv');
      const postalCode = document.getElementById('postalCode');
      
      // ã‚«ãƒ¼ãƒ‰ç•ªå·ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
      cardNumber.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        value = value.replace(/(\d{4})(?=\d)/g, '$1 ');
        e.target.value = value;
      });
      
      // æœ‰åŠ¹æœŸé™ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
      expiryDate.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length >= 2) {
          value = value.substring(0, 2) + '/' + value.substring(2, 4);
        }
        e.target.value = value;
      });
      
      // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        processPayment();
      });
      
      // Enterã‚­ãƒ¼ã§ã®é€ä¿¡
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          const activeElement = document.activeElement;
          if (activeElement && activeElement.tagName === 'INPUT') {
            e.preventDefault();
            processPayment();
          }
        }
      });
    }
    
    // æ±ºæ¸ˆå‡¦ç†
    async function processPayment() {
      const paymentButton = document.getElementById('paymentButton');
      const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
      const expiryDate = document.getElementById('expiryDate').value;
      const cvv = document.getElementById('cvv').value;
      const postalCode = document.getElementById('postalCode').value;
      
      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!validatePaymentForm(cardNumber, expiryDate, cvv, postalCode)) {
        return;
      }
      
      // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
      paymentButton.disabled = true;
      paymentButton.innerHTML = `
        <span class="button-icon">â³</span>
        <span class="button-text">æ±ºæ¸ˆå‡¦ç†ä¸­...</span>
        <span class="button-subtext">ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„</span>
      `;
      
      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
      showLoading();
      
      try {
        // UIDã‚’å–å¾—
        let uid = localStorage.getItem('currentUID');
        if (!uid) {
          uid = generateUID();
          localStorage.setItem('currentUID', uid);
        }
        
        // ãƒã‚±ãƒƒãƒˆæƒ…å ±ã‚’ä¿å­˜
        const ticketData = {
          type: 'first-time',
          name: 'ä½“é¨“ãƒã‚±ãƒƒãƒˆ',
          price: 100,
          minutes: 5,
          uid: uid,
          timestamp: new Date().toISOString()
        };
        
        localStorage.setItem('selectedTicket', JSON.stringify(ticketData));
        console.log('ãƒã‚±ãƒƒãƒˆæƒ…å ±ã‚’ä¿å­˜:', ticketData);
        
        // æ±ºæ¸ˆå‡¦ç†ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
        await simulatePaymentProcess(ticketData);
        
      } catch (error) {
        console.error('æ±ºæ¸ˆå‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
        hideLoading();
        showError('æ±ºæ¸ˆå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
        
        // ãƒœã‚¿ãƒ³ã‚’å¾©å…ƒ
        resetPaymentButton();
      }
    }
    
    // ãƒ†ã‚¹ãƒˆç”¨æ±ºæ¸ˆå‡¦ç†ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
    async function simulatePaymentProcess(ticketData) {
      console.log('ãƒ†ã‚¹ãƒˆç”¨æ±ºæ¸ˆå‡¦ç†ã‚’é–‹å§‹');
      
      // 2ç§’é–“ã®å‡¦ç†ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
      await new Promise(resolve => setTimeout(resolve, 2000));
      
      // æ±ºæ¸ˆæˆåŠŸã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
      console.log('æ±ºæ¸ˆå‡¦ç†å®Œäº†ã€ãƒãƒ£ãƒƒãƒˆãƒšãƒ¼ã‚¸ã«é·ç§»');
      
      // ãƒãƒ£ãƒƒãƒˆãƒšãƒ¼ã‚¸ã«é·ç§»
      const chatUrl = `./consult/chat.html?nickname=${testUserData.nickname}&year=${testUserData.year}&month=${testUserData.month}&day=${testUserData.day}&guardian=${testUserData.guardianKey}&worry=${encodeURIComponent(testUserData.worry)}`;
      
      hideLoading();
      showMessage('âœ… æ±ºæ¸ˆå®Œäº†ï¼ãƒãƒ£ãƒƒãƒˆãƒšãƒ¼ã‚¸ã«é·ç§»ã—ã¾ã™', 'success');
      
      setTimeout(() => {
        window.location.href = chatUrl;
      }, 1500);
    }
    
    // ãƒ•ã‚©ãƒ¼ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    function validatePaymentForm(cardNumber, expiryDate, cvv, postalCode) {
      let isValid = true;
      let errorMessage = '';
      
      if (!cardNumber || cardNumber.length < 16) {
        errorMessage = 'ã‚«ãƒ¼ãƒ‰ç•ªå·ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
        isValid = false;
      } else if (!expiryDate || expiryDate.length < 5) {
        errorMessage = 'æœ‰åŠ¹æœŸé™ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
        isValid = false;
      } else if (!cvv || cvv.length < 3) {
        errorMessage = 'CVCã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
        isValid = false;
      } else if (!postalCode) {
        errorMessage = 'éƒµä¾¿ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
        isValid = false;
      }
      
      if (!isValid) {
        showError(errorMessage);
      }
      
      return isValid;
    }
    
    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
    function showLoading() {
      const loadingOverlay = document.getElementById('loadingOverlay');
      loadingOverlay.classList.add('show');
    }
    
    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éè¡¨ç¤º
    function hideLoading() {
      const loadingOverlay = document.getElementById('loadingOverlay');
      loadingOverlay.classList.remove('show');
    }
    
    // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
    function showError(message) {
      const errorMessage = document.getElementById('errorMessage');
      const errorText = document.getElementById('errorText');
      
      errorText.textContent = message;
      errorMessage.classList.add('show');
      
      // 5ç§’å¾Œã«è‡ªå‹•ã§éè¡¨ç¤º
      setTimeout(() => {
        hideError();
      }, 5000);
    }
    
    // æ±ºæ¸ˆãƒœã‚¿ãƒ³ã‚’å¾©å…ƒ
    function resetPaymentButton() {
      const paymentButton = document.getElementById('paymentButton');
      paymentButton.disabled = false;
      paymentButton.innerHTML = `
        <span class="button-icon">âœ¨</span>
        <span class="button-text">100å††ã§ä½“é¨“ã‚’é–‹å§‹</span>
        <span class="button-subtext">5åˆ†é–“ã®ç¥ç§˜çš„ãªé‘‘å®š</span>
      `;
    }
    
    // UIDç”Ÿæˆ
    function generateUID() {
      const timestamp = Date.now().toString(36);
      const randomStr = Math.random().toString(36).substring(2, 15);
      return `test_user_${timestamp}_${randomStr}`;
    }
    
    // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã®å‡¦ç†
    window.addEventListener('beforeunload', function() {
      hideLoading();
      hideError();
    });
    
    // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
    window.addEventListener('error', function(event) {
      console.error('JavaScript ã‚¨ãƒ©ãƒ¼:', event.error);
      hideLoading();
      showError('äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
    });
    
    // æœªå‡¦ç†ã®Promise rejectionã‚’ã‚­ãƒ£ãƒƒãƒ
    window.addEventListener('unhandledrejection', function(event) {
      console.error('æœªå‡¦ç†ã®Promise rejection:', event.reason);
      hideLoading();
      showError('å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
      event.preventDefault();
    });
  </script>
</body>
</html>
