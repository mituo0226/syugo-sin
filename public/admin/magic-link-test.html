<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>マジックリンク会員登録テスト | AI鑑定師 龍</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0d0d1a 0%, #1a1a2e 50%, #16213e 100%);
      color: #fff;
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: rgba(13, 13, 26, 0.8);
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }
    
    .title {
      text-align: center;
      color: #66ccff;
      margin-bottom: 30px;
      font-size: 2.5em;
      text-shadow: 0 0 20px rgba(102, 204, 255, 0.5);
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: #ccc;
      font-weight: bold;
    }
    
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #444;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      font-size: 16px;
      box-sizing: border-box;
    }
    
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: #66ccff;
      box-shadow: 0 0 10px rgba(102, 204, 255, 0.3);
    }
    
    .form-group select option {
      background: #0d0d1a;
      color: #fff;
    }
    
    .form-group input::placeholder, .form-group textarea::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }
    
    .submit-button {
      width: 100%;
      padding: 15px;
      background: linear-gradient(90deg, #66ccff, #4dd0e1);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 10px;
    }
    
    .submit-button:hover {
      background: linear-gradient(90deg, #4dd0e1, #26c6da);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 204, 255, 0.4);
    }
    
    .submit-button:disabled {
      background: #666;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .message-area {
      margin-top: 20px;
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      font-weight: bold;
    }
    
    .success-message {
      background: rgba(76, 175, 80, 0.2);
      color: #4caf50;
      border: 1px solid rgba(76, 175, 80, 0.3);
    }
    
    .error-message {
      background: rgba(244, 67, 54, 0.2);
      color: #f44336;
      border: 1px solid rgba(244, 67, 54, 0.3);
    }
    
    .info-message {
      background: rgba(33, 150, 243, 0.2);
      color: #2196f3;
      border: 1px solid rgba(33, 150, 243, 0.3);
    }
    
    .log-area {
      margin-top: 30px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      padding: 20px;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid rgba(102, 204, 255, 0.2);
    }
    
    .log-entry {
      margin-bottom: 8px;
      padding: 8px 12px;
      border-radius: 5px;
      font-family: monospace;
      font-size: 14px;
      border-left: 3px solid transparent;
    }
    
    .log-success {
      background: rgba(76, 175, 80, 0.1);
      color: #4caf50;
      border-left-color: #4caf50;
    }
    
    .log-error {
      background: rgba(244, 67, 54, 0.1);
      color: #f44336;
      border-left-color: #f44336;
    }
    
    .log-info {
      background: rgba(102, 204, 255, 0.1);
      color: #66ccff;
      border-left-color: #66ccff;
    }
    
    .back-link {
      display: inline-block;
      margin-top: 30px;
      color: #66ccff;
      text-decoration: none;
      padding: 10px 20px;
      border: 1px solid #66ccff;
      border-radius: 5px;
      transition: all 0.3s ease;
    }
    
    .back-link:hover {
      background: rgba(102, 204, 255, 0.1);
      transform: translateY(-1px);
    }
    
    .magic-link-info {
      background: rgba(255, 255, 255, 0.05);
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      border: 1px solid rgba(102, 204, 255, 0.3);
    }
    
    .magic-link-info h3 {
      color: #66ccff;
      margin-top: 0;
      margin-bottom: 10px;
    }
    
    .magic-link-info p {
      color: #ccc;
      margin: 5px 0;
      font-size: 14px;
    }
    
    .link-display {
      background: rgba(0, 0, 0, 0.3);
      padding: 10px;
      border-radius: 5px;
      margin-top: 10px;
      word-break: break-all;
      font-family: monospace;
      font-size: 12px;
      color: #66ccff;
    }
    
    .link-button {
      background: linear-gradient(90deg, #ff6b6b, #ff8e8e);
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 10px;
      transition: all 0.3s ease;
    }
    
    .link-button:hover {
      background: linear-gradient(90deg, #ff5252, #ff6b6b);
      transform: translateY(-1px);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="title">マジックリンク会員登録テスト</h1>
    
    <div class="magic-link-info">
      <h3>マジックリンク会員登録について</h3>
      <p>• メールアドレスとニックネームは必須項目です</p>
      <p>• 生年月日を入力すると、守護神が自動選択されます</p>
      <p>• マジックリンクが生成され、そのリンクをクリックすることで会員登録が完了します</p>
      <p>• マジックリンクの有効期限は30分間です</p>
    </div>
    
    <form id="magicLinkForm">
      <div class="form-group">
        <label for="email">メールアドレス *</label>
        <input type="email" id="email" name="email" placeholder="user@example.com" required>
      </div>
      
      <div class="form-group">
        <label for="nickname">ニックネーム *</label>
        <input type="text" id="nickname" name="nickname" placeholder="ニックネームを入力してください" required>
      </div>
      
      <div class="form-group">
        <label for="birthdate">生年月日</label>
        <input type="date" id="birthdate" name="birthdate">
      </div>
      
      <div class="form-group">
        <label for="guardianId">守護神ID</label>
        <select id="guardianId" name="guardianId">
          <option value="">守護神を選択してください</option>
          <option value="千手観音">千手観音</option>
          <option value="薬師如来">薬師如来</option>
          <option value="阿弥陀如来">阿弥陀如来</option>
          <option value="大日如来">大日如来</option>
          <option value="文殊菩薩">文殊菩薩</option>
          <option value="普賢菩薩">普賢菩薩</option>
          <option value="勢至菩薩">勢至菩薩</option>
          <option value="虚空蔵菩薩">虚空蔵菩薩</option>
          <option value="不動明王">不動明王</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="theme">テーマ・悩み</label>
        <textarea id="theme" name="theme" placeholder="相談したいテーマや悩みを入力してください" rows="3"></textarea>
      </div>
      
      <button type="submit" class="submit-button" id="submitButton">
        マジックリンクを送信
      </button>
      
      <button type="button" class="submit-button" id="debugButton" style="background: linear-gradient(90deg, #ff6b6b, #ff8e8e); margin-top: 10px;">
        ユーザー状況をデバッグ
      </button>
    </form>
    
    <div id="messageArea"></div>
    
    <div id="magicLinkArea" style="display: none;">
      <h3 style="color: #66ccff; margin-top: 30px;">マジックリンクが生成されました</h3>
      <p style="color: #ccc; margin: 10px 0;">以下のリンクをクリックして会員登録を完了してください：</p>
      <div class="link-display" id="magicLinkDisplay"></div>
      <button class="link-button" id="openLinkButton">リンクを開く</button>
    </div>
    
    <div class="log-area" id="logArea">
      <div class="log-entry log-info">ログがここに表示されます...</div>
    </div>
    
    <a href="admin.html" class="back-link">← 管理画面に戻る</a>
  </div>

  <script>
    // ログ表示関数
    function addLog(message, type = 'info') {
      const logArea = document.getElementById('logArea');
      const logEntry = document.createElement('div');
      logEntry.className = `log-entry log-${type}`;
      
      const timestamp = new Date().toLocaleTimeString();
      logEntry.textContent = `[${timestamp}] ${message}`;
      
      logArea.appendChild(logEntry);
      logArea.scrollTop = logArea.scrollHeight;
      
      if (type === 'error') {
        console.error(message);
      } else if (type === 'success') {
        console.log(message);
      } else {
        console.log(message);
      }
    }
    
    // 十二支を計算する関数（本番環境と同じ）
    function calculateZodiac(year, month, day) {
      const zodiacSigns = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];
      const zodiacYear = year - 4;
      const zodiacIndex = zodiacYear % 12;
      return zodiacSigns[zodiacIndex < 0 ? zodiacIndex + 12 : zodiacIndex];
    }
    
    // 生年月日から守護神を取得する関数
    function getGuardianByBirthdate(birthdate) {
      if (!birthdate) return null;
      
      const date = new Date(birthdate);
      const year = date.getFullYear();
      const month = date.getMonth() + 1;
      const day = date.getDate();
      
      const zodiac = calculateZodiac(year, month, day);
      
      // 本番環境と同じ守護神マッピング
      const guardianKeyMap = {
        '子': '千手観音',
        '丑': '虚空蔵菩薩',
        '寅': '虚空蔵菩薩',
        '卯': '文殊菩薩',
        '辰': '普賢菩薩',
        '巳': '普賢菩薩',
        '午': '勢至菩薩',
        '未': '大日如来',
        '申': '大日如来',
        '酉': '不動明王',
        '戌': '阿弥陀如来',
        '亥': '薬師如来'
      };
      
      return guardianKeyMap[zodiac];
    }
    
    // 生年月日入力時の守護神自動選択
    document.addEventListener('DOMContentLoaded', function() {
      const birthdateInput = document.getElementById('birthdate');
      const guardianSelect = document.getElementById('guardianId');
      
      birthdateInput.addEventListener('change', function() {
        const selectedGuardian = getGuardianByBirthdate(this.value);
        if (selectedGuardian) {
          guardianSelect.value = selectedGuardian;
          addLog(`生年月日 ${this.value} に基づいて守護神を自動選択: ${selectedGuardian}`);
        }
      });
    });
    
    // フォーム送信処理
    document.getElementById('magicLinkForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const submitButton = document.getElementById('submitButton');
      const messageArea = document.getElementById('messageArea');
      const magicLinkArea = document.getElementById('magicLinkArea');
      
      // ボタンを無効化
      submitButton.disabled = true;
      submitButton.textContent = 'マジックリンク送信中...';
      
      // メッセージエリアとマジックリンクエリアをクリア
      messageArea.innerHTML = '';
      magicLinkArea.style.display = 'none';
      
      try {
        // フォームデータを取得
        const email = document.getElementById('email').value.trim();
        const nickname = document.getElementById('nickname').value.trim();
        const birthdate = document.getElementById('birthdate').value;
        const guardianId = document.getElementById('guardianId').value;
        const theme = document.getElementById('theme').value.trim();
        
        // バリデーション
        if (!email || !nickname) {
          throw new Error('メールアドレスとニックネームは必須です');
        }
        
        addLog(`マジックリンク送信開始: email=${email}, nickname=${nickname}`);
        addLog(`API URL: https://syugo-sin-worker.mituo0226.workers.dev/api/send-magic-link`);
        
        // APIに送信
        const response = await fetch('https://syugo-sin-worker.mituo0226.workers.dev/api/send-magic-link', {
          method: 'POST',
          mode: 'cors',
          credentials: 'omit',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
          },
          body: JSON.stringify({
            email: email,
            nickname: nickname,
            birthdate: birthdate,
            guardian_id: guardianId,
            theme: theme
          })
        });
        
        addLog(`レスポンス受信: ${response.status} ${response.statusText}`);
        
        if (!response.ok) {
          const errorData = await response.json();
          if (response.status === 409 && errorData.error === "このメールアドレスは既に登録されています") {
            throw new Error(`${errorData.error}（既存のユーザーID: ${errorData.existing_id}）`);
          }
          throw new Error(`送信エラー: ${response.status} - ${errorData.error || 'Unknown error'}`);
        }
        
        const result = await response.json();
        addLog('マジックリンク送信完了', 'success');
        addLog(`送信結果: ${JSON.stringify(result, null, 2)}`);
        
        // 成功メッセージを表示
        const emailStatus = result.email_sent ? 
          '<span style="color: #4caf50;">✓ メール送信成功</span>' : 
          `<span style="color: #f44336;">✗ メール送信失敗: ${result.email_error || '不明なエラー'}</span>`;
        
        messageArea.innerHTML = `
          <div class="success-message">
            ${result.email_sent ? 'マジックリンクをメールで送信しました！' : 'マジックリンクを生成しました！'}<br>
            メールアドレス: ${result.email}<br>
            メール送信状況: ${emailStatus}<br>
            有効期限: ${new Date(result.expires_at).toLocaleString()}
          </div>
        `;
        
        // マジックリンクを表示
        document.getElementById('magicLinkDisplay').textContent = result.magic_link_url;
        magicLinkArea.style.display = 'block';
        
        // リンクを開くボタンのイベントリスナー
        document.getElementById('openLinkButton').onclick = function() {
          window.open(result.magic_link_url, '_blank');
        };
        
      } catch (error) {
        addLog('送信エラー: ' + error.message, 'error');
        messageArea.innerHTML = `<div class="error-message">マジックリンク送信に失敗しました: ${error.message}</div>`;
      } finally {
        // ボタンを有効化
        submitButton.disabled = false;
        submitButton.textContent = 'マジックリンクを送信';
      }
    });
    
    // デバッグボタンのイベントリスナー
    document.getElementById('debugButton').addEventListener('click', async function() {
      const email = document.getElementById('email').value.trim();
      const messageArea = document.getElementById('messageArea');
      
      if (!email) {
        messageArea.innerHTML = '<div class="error-message">デバッグするメールアドレスを入力してください</div>';
        return;
      }
      
      try {
        addLog(`ユーザー状況デバッグ開始: ${email}`);
        
        const response = await fetch('https://syugo-sin-worker.mituo0226.workers.dev/api/debug-user', {
          method: 'POST',
          mode: 'cors',
          credentials: 'omit',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
          },
          body: JSON.stringify({ email: email })
        });
        
        if (!response.ok) {
          throw new Error(`デバッグエラー: ${response.status}`);
        }
        
        const result = await response.json();
        addLog('デバッグ完了', 'success');
        addLog(`デバッグ結果: ${JSON.stringify(result, null, 2)}`);
        
        // 結果を表示
        let debugInfo = `
          <div class="info-message">
            <h4>ユーザー状況デバッグ結果</h4>
            <p><strong>メールアドレス:</strong> ${result.email}</p>
            <p><strong>ユーザー存在:</strong> ${result.user_exists ? 'はい' : 'いいえ'}</p>
            <p><strong>マジックリンク数:</strong> ${result.magic_links_count}件</p>
        `;
        
        if (result.user_data) {
          debugInfo += `
            <p><strong>ユーザーID:</strong> ${result.user_data.id}</p>
            <p><strong>ニックネーム:</strong> ${result.user_data.nickname}</p>
            <p><strong>登録日時:</strong> ${result.user_data.created_at}</p>
          `;
        }
        
        if (result.magic_links && result.magic_links.length > 0) {
          debugInfo += `<p><strong>マジックリンク履歴:</strong></p><ul>`;
          result.magic_links.forEach((link, index) => {
            debugInfo += `<li>${index + 1}. トークン: ${link.token.substring(0, 8)}..., 使用済み: ${link.used ? 'はい' : 'いいえ'}, 作成日: ${link.created_at}</li>`;
          });
          debugInfo += `</ul>`;
        }
        
        debugInfo += `</div>`;
        
        messageArea.innerHTML = debugInfo;
        
      } catch (error) {
        addLog('デバッグエラー: ' + error.message, 'error');
        messageArea.innerHTML = `<div class="error-message">デバッグに失敗しました: ${error.message}</div>`;
      }
    });
    
    // ページ読み込み時の処理
    window.addEventListener('load', function() {
      addLog('マジックリンク会員登録テストページ読み込み完了');
    });
  </script>
</body>
</html>
