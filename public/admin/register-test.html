<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>会員登録テスト | AI鑑定師 龍</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      margin: 0;
      background: #0d0d1a;
      font-family: "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
      color: #fff;
      padding: 20px;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: rgba(13, 13, 26, 0.9);
      border-radius: 20px;
      padding: 40px;
      border: 2px solid rgba(102, 204, 255, 0.4);
    }
    
    .title {
      font-size: 2em;
      color: #66ccff;
      text-align: center;
      margin-bottom: 30px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: #ccc;
      font-weight: bold;
    }
    
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #444;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      font-size: 16px;
      box-sizing: border-box;
    }
    
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: #66ccff;
      box-shadow: 0 0 10px rgba(102, 204, 255, 0.3);
    }
    
    .form-group input::placeholder, .form-group textarea::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }
    
    .submit-button {
      width: 100%;
      padding: 20px;
      font-size: 1.3em;
      background: linear-gradient(90deg, #66ccff, #3399ff);
      border: none;
      border-radius: 15px;
      font-weight: bold;
      cursor: pointer;
      color: #000;
      box-shadow: 0 6px 20px rgba(102,204,255,0.4);
      transition: all 0.3s ease;
      margin-top: 20px;
    }
    
    .submit-button:hover {
      background: linear-gradient(90deg, #99e0ff, #66ccff);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102,204,255,0.5);
    }
    
    .submit-button:disabled {
      background: #666;
      cursor: not-allowed;
      transform: none;
    }
    
    .localStorage-info {
      background: rgba(102, 204, 255, 0.1);
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 30px;
      border: 2px solid rgba(102, 204, 255, 0.3);
    }
    
    .localStorage-info h3 {
      color: #66ccff;
      margin-bottom: 15px;
    }
    
    .localStorage-info p {
      color: #ccc;
      margin: 5px 0;
    }
    
    .result-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 30px;
      background: rgba(13, 13, 26, 0.8);
      border-radius: 10px;
      overflow: hidden;
    }
    
    .result-table th, .result-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid rgba(102, 204, 255, 0.2);
    }
    
    .result-table th {
      background: rgba(102, 204, 255, 0.2);
      color: #66ccff;
      font-weight: bold;
    }
    
    .result-table td {
      color: #fff;
    }
    
    .success-message {
      color: #66ff66;
      margin-top: 20px;
      padding: 15px;
      background: rgba(102, 255, 102, 0.1);
      border-radius: 8px;
      border: 1px solid rgba(102, 255, 102, 0.3);
      text-align: center;
      font-weight: bold;
    }
    
    .error-message {
      color: #ff6b6b;
      margin-top: 20px;
      padding: 15px;
      background: rgba(255, 107, 107, 0.1);
      border-radius: 8px;
      border: 1px solid rgba(255, 107, 107, 0.3);
      text-align: center;
    }
    
    .back-link {
      display: inline-block;
      margin-top: 30px;
      padding: 10px 20px;
      background: rgba(102, 204, 255, 0.2);
      color: #66ccff;
      text-decoration: none;
      border-radius: 8px;
      border: 1px solid rgba(102, 204, 255, 0.4);
      transition: all 0.3s ease;
    }
    
    .back-link:hover {
      background: rgba(102, 204, 255, 0.3);
      transform: translateY(-2px);
    }
    
    .log-area {
      background: rgba(0, 0, 0, 0.5);
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
      font-family: monospace;
      font-size: 14px;
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid rgba(102, 204, 255, 0.2);
    }
    
    .log-entry {
      margin: 5px 0;
      padding: 5px;
      border-radius: 4px;
    }
    
    .log-success {
      background: rgba(102, 255, 102, 0.1);
      color: #66ff66;
    }
    
    .log-error {
      background: rgba(255, 107, 107, 0.1);
      color: #ff6b6b;
    }
    
    .log-info {
      background: rgba(102, 204, 255, 0.1);
      color: #66ccff;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="title">会員登録テスト</h1>
    
    
    <!-- 入力フォーム -->
    <div style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid rgba(102, 204, 255, 0.3);">
      <h3 style="color: #66ccff; margin-top: 0; margin-bottom: 10px;">入力方法</h3>
      <p style="color: #ccc; margin: 5px 0; font-size: 14px;">
        • すべての項目を手動で入力してください<br>
        • メールアドレスとニックネームは必須項目です<br>
        • 生年月日を入力すると、守護神が自動選択されます
      </p>
    </div>
    
    <form id="registerForm">
      <div class="form-group">
        <label for="email">メールアドレス *</label>
        <input type="email" id="email" name="email" placeholder="your@email.com" required>
      </div>
      
      <div class="form-group">
        <label for="manualNickname">ニックネーム *</label>
        <input type="text" id="manualNickname" name="manualNickname" placeholder="ニックネームを入力してください" required>
      </div>
      
      <div class="form-group">
        <label for="birthdate">生年月日</label>
        <input type="date" id="birthdate" name="birthdate">
      </div>
      
      <div class="form-group">
        <label for="guardianId">守護神ID</label>
        <select id="guardianId" name="guardianId">
          <option value="">守護神を選択してください</option>
          <option value="千手観音">千手観音</option>
          <option value="虚空蔵菩薩">虚空蔵菩薩</option>
          <option value="文殊菩薩">文殊菩薩</option>
          <option value="普賢菩薩">普賢菩薩</option>
          <option value="勢至菩薩">勢至菩薩</option>
          <option value="大日如来">大日如来</option>
          <option value="不動明王">不動明王</option>
          <option value="阿弥陀如来">阿弥陀如来</option>
          <option value="薬師如来">薬師如来</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="theme">テーマ・悩み</label>
        <textarea id="theme" name="theme" placeholder="相談したいテーマや悩みを入力してください" rows="3"></textarea>
      </div>
      
      <button type="submit" class="submit-button" id="submitButton">
        会員登録情報を保存
      </button>
    </form>
    
    <!-- 結果表示エリア -->
    <div id="resultArea" style="display: none;">
      <h3 style="color: #66ccff; margin-top: 30px;">保存結果</h3>
      <table class="result-table" id="resultTable">
        <thead>
          <tr>
            <th>項目</th>
            <th>値</th>
          </tr>
        </thead>
        <tbody id="resultTableBody">
        </tbody>
      </table>
    </div>
    
    <!-- メッセージ表示エリア -->
    <div id="messageArea"></div>
    
    <!-- ログ表示エリア -->
    <div class="log-area" id="logArea">
      <div class="log-entry log-info">ログがここに表示されます...</div>
    </div>
    
    <!-- 管理画面に戻るリンク -->
    <a href="admin.html" class="back-link">管理画面に戻る</a>
  </div>

  <script>
    // ログ表示関数
    function addLog(message, type = 'info') {
      const logArea = document.getElementById('logArea');
      const logEntry = document.createElement('div');
      logEntry.className = `log-entry log-${type}`;
      logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logArea.appendChild(logEntry);
      logArea.scrollTop = logArea.scrollHeight;
      
      // コンソールにも出力
      if (type === 'error') {
        console.error(message);
      } else if (type === 'success') {
        console.log(message);
      } else {
        console.log(message);
      }
    }
    
    
    // 十二支を計算する関数（本番環境と同じ）
    function calculateZodiac(year, month, day) {
      const zodiacSigns = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];
      const zodiacYear = year - 4;
      const zodiacIndex = zodiacYear % 12;
      const zodiac = zodiacSigns[zodiacIndex];
      
      console.log(`十二支計算: ${year}年 → ${zodiacYear} → ${zodiacIndex} → ${zodiac}`);
      
      return zodiac;
    }
    
    // 守護神選択ロジック（本番環境と同じ）
    function getGuardianByBirthdate(birthdate) {
      if (!birthdate) return null;
      
      const date = new Date(birthdate);
      const year = date.getFullYear();
      const month = date.getMonth() + 1;
      const day = date.getDate();
      
      // 十二支を計算
      const zodiac = calculateZodiac(year, month, day);
      
      // 守護神キーマップ（本番環境と同じ）
      const guardianKeyMap = {
        '子': '千手観音',
        '丑': '虚空蔵菩薩',
        '寅': '虚空蔵菩薩',
        '卯': '文殊菩薩',
        '辰': '普賢菩薩',
        '巳': '普賢菩薩',
        '午': '勢至菩薩',
        '未': '大日如来',
        '申': '大日如来',
        '酉': '不動明王',
        '戌': '阿弥陀如来',
        '亥': '薬師如来'
      };
      
      return guardianKeyMap[zodiac];
    }
    
    
    // フォーム送信処理
    document.getElementById('registerForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const submitButton = document.getElementById('submitButton');
      const messageArea = document.getElementById('messageArea');
      const resultArea = document.getElementById('resultArea');
      
      // ボタンを無効化
      submitButton.disabled = true;
      submitButton.textContent = '保存中...';
      
      // メッセージエリアをクリア
      messageArea.innerHTML = '';
      resultArea.style.display = 'none';
      
      try {
        // フォームデータを取得
        const email = document.getElementById('email').value.trim();
        const manualNickname = document.getElementById('manualNickname').value.trim();
        const birthdate = document.getElementById('birthdate').value;
        const guardianId = document.getElementById('guardianId').value;
        const theme = document.getElementById('theme').value.trim();
        
        // バリデーション
        if (!email) {
          throw new Error('メールアドレスは必須です');
        }
        if (!manualNickname) {
          throw new Error('ニックネームは必須です');
        }
        
        // 手動入力データを使用
        let finalNickname = manualNickname;
        let finalBirthdate = birthdate;
        let finalGuardianId = guardianId;
        let finalTheme = theme;
        
        addLog(`手動入力のニックネームを使用: ${finalNickname}`);
        addLog(`手動入力の生年月日を使用: ${finalBirthdate || '未入力'}`);
        addLog(`手動入力の守護神IDを使用: ${finalGuardianId || '未選択'}`);
        addLog(`手動入力のテーマを使用: ${finalTheme || '未入力'}`);
        
        // 送信データを構築
        const requestData = {
          email: email,
          nickname: finalNickname,
          birthdate: finalBirthdate || null,
          guardian_id: finalGuardianId || null,
          theme: finalTheme || null
        };
        
        addLog('送信データ: ' + JSON.stringify(requestData, null, 2));
        
        // APIに送信
        const response = await fetch('https://syugo-sin-worker.mituo0226.workers.dev/api/register', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(requestData)
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          if (response.status === 409 && errorData.error === "このメールアドレスは既に登録されています") {
            // 重複エラーの場合、退会の案内を表示
            const messageArea = document.getElementById('messageArea');
            messageArea.innerHTML = `
              <div class="error-message">
                ${errorData.error}<br>
                既存のユーザーID: ${errorData.existing_id}<br><br>
                同じメールアドレスで再登録する場合は、まず退会処理を行う必要があります。<br>
                退会後は同じメールアドレスで再登録が可能になります。
              </div>
            `;
            addLog(`重複エラー: 既存のユーザーID ${errorData.existing_id}`, 'error');
          }
          throw new Error(`API エラー: ${response.status} - ${errorData.error || 'Unknown error'}`);
        }
        
        const result = await response.json();
        addLog('保存成功: ' + JSON.stringify(result, null, 2), 'success');
        
        // 成功メッセージを表示
        messageArea.innerHTML = '<div class="success-message">保存しました！</div>';
        
        // 保存結果を表形式で表示
        const resultTableBody = document.getElementById('resultTableBody');
        resultTableBody.innerHTML = '';
        
        const resultData = [
          { label: 'ID', value: result.id || 'N/A' },
          { label: 'メールアドレス', value: result.email },
          { label: 'ニックネーム', value: result.nickname },
          { label: '生年月日', value: result.birthdate || '未設定' },
          { label: '守護神ID', value: result.guardian_id || '未設定' },
          { label: 'テーマ', value: result.theme || '未設定' },
          { label: '作成日時', value: result.created_at || 'N/A' }
        ];
        
        resultData.forEach(item => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${item.label}</td>
            <td>${item.value}</td>
          `;
          resultTableBody.appendChild(row);
        });
        
        resultArea.style.display = 'block';
        
        // 確認ボタンを追加
        const verifyButton = document.createElement('button');
        verifyButton.textContent = 'Cloudflare側の保存状況を確認';
        verifyButton.className = 'submit-button';
        verifyButton.style.marginTop = '20px';
        verifyButton.style.backgroundColor = 'linear-gradient(90deg, #ffd700, #ffed4e)';
        verifyButton.style.color = '#000';
        verifyButton.onclick = () => verifyUserData(result.id);
        resultArea.appendChild(verifyButton);
        
        // 削除ボタンを追加
        const deleteButton = document.createElement('button');
        deleteButton.textContent = 'このユーザーデータを削除';
        deleteButton.className = 'submit-button';
        deleteButton.style.marginTop = '10px';
        deleteButton.style.backgroundColor = 'linear-gradient(90deg, #ff6b6b, #ff8e8e)';
        deleteButton.style.color = '#fff';
        deleteButton.onclick = () => deleteUserData(result.id);
        resultArea.appendChild(deleteButton);
        
        // 退会ボタンを追加
        const withdrawButton = document.createElement('button');
        withdrawButton.textContent = 'このメールアドレスで退会';
        withdrawButton.className = 'submit-button';
        withdrawButton.style.marginTop = '10px';
        withdrawButton.style.backgroundColor = 'linear-gradient(90deg, #6c757d, #495057)';
        withdrawButton.style.color = '#fff';
        withdrawButton.onclick = () => withdrawUser(result.email);
        resultArea.appendChild(withdrawButton);
        
        // 全テストデータ削除ボタンを追加
        const deleteAllButton = document.createElement('button');
        deleteAllButton.textContent = 'テストデータを全削除';
        deleteAllButton.className = 'submit-button';
        deleteAllButton.style.marginTop = '10px';
        deleteAllButton.style.backgroundColor = 'linear-gradient(90deg, #dc3545, #e74c3c)';
        deleteAllButton.style.color = '#fff';
        deleteAllButton.onclick = () => deleteAllTestData();
        resultArea.appendChild(deleteAllButton);
        
      } catch (error) {
        addLog('保存エラー: ' + error.message, 'error');
        messageArea.innerHTML = `<div class="error-message">保存に失敗しました: ${error.message}</div>`;
      } finally {
        // ボタンを有効化
        submitButton.disabled = false;
        submitButton.textContent = '会員登録情報を保存';
      }
    });
    
    // ユーザーデータ確認機能
    async function verifyUserData(userId) {
      try {
        addLog(`ユーザーID ${userId} の保存状況を確認中...`);
        
        const apiUrl = `https://syugo-sin-worker.mituo0226.workers.dev/api/verify-user/${userId}`;
        addLog(`API URL: ${apiUrl}`);
        
        // CORSエラーを回避するため、modeを明示的に設定
        const response = await fetch(apiUrl, {
          method: 'GET',
          mode: 'cors',
          credentials: 'omit',
          headers: {
            'Content-Type': 'application/json',
          }
        });
        
        addLog(`レスポンス受信: ${response.status} ${response.statusText}`);
        
        if (!response.ok) {
          const errorText = await response.text();
          addLog(`HTTPエラー: ${response.status} - ${errorText}`, 'error');
          throw new Error(`確認エラー: ${response.status} - ${errorText}`);
        }
        
        const userData = await response.json();
        addLog('Cloudflare側の保存状況確認完了', 'success');
        addLog(`確認結果: ${JSON.stringify(userData, null, 2)}`);
        
        // 確認結果を表示
        const verifyResult = document.createElement('div');
        verifyResult.innerHTML = `
          <h4 style="color: #66ccff; margin-top: 20px;">Cloudflare側保存状況</h4>
          <table class="result-table">
            <thead>
              <tr>
                <th>項目</th>
                <th>値</th>
              </tr>
            </thead>
            <tbody>
              <tr><td>ID</td><td>${userData.id || 'N/A'}</td></tr>
              <tr><td>メールアドレス</td><td>${userData.email || 'N/A'}</td></tr>
              <tr><td>ニックネーム</td><td>${userData.nickname || 'N/A'}</td></tr>
              <tr><td>生年月日</td><td>${userData.birthdate || 'N/A'}</td></tr>
              <tr><td>守護神ID</td><td>${userData.guardian_id || 'N/A'}</td></tr>
              <tr><td>テーマ</td><td>${userData.theme || 'N/A'}</td></tr>
              <tr><td>作成日時</td><td>${userData.created_at || 'N/A'}</td></tr>
            </tbody>
          </table>
        `;
        
        document.getElementById('resultArea').appendChild(verifyResult);
        
      } catch (error) {
        addLog('確認エラー: ' + error.message, 'error');
      }
    }
    
    // ユーザーデータ削除機能
    async function deleteUserData(userId) {
      if (!confirm(`ユーザーID ${userId} のデータを削除しますか？この操作は取り消せません。`)) {
        return;
      }
      
      try {
        addLog(`ユーザーID ${userId} のデータを削除中...`);
        
        const response = await fetch('https://syugo-sin-worker.mituo0226.workers.dev/api/delete-user', {
          method: 'POST',
          mode: 'cors',
          credentials: 'omit',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ userId: userId })
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(`削除エラー: ${response.status} - ${errorData.error || 'Unknown error'}`);
        }
        
        const result = await response.json();
        addLog('ユーザーデータ削除完了', 'success');
        addLog(`削除結果: ${JSON.stringify(result, null, 2)}`);
        
        // ページをリロードして最新状態を表示
        setTimeout(() => {
          location.reload();
        }, 2000);
        
      } catch (error) {
        addLog('削除エラー: ' + error.message, 'error');
      }
    }
    
    // 全テストデータ削除機能
    async function deleteAllTestData() {
      if (!confirm('テストデータ（mituo0226@gmail.com）を全て削除しますか？この操作は取り消せません。')) {
        return;
      }
      
      try {
        addLog('テストデータを全削除中...');
        
        const response = await fetch('https://syugo-sin-worker.mituo0226.workers.dev/api/delete-all-test-data', {
          method: 'POST',
          mode: 'cors',
          credentials: 'omit',
          headers: {
            'Content-Type': 'application/json',
          }
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(`削除エラー: ${response.status} - ${errorData.error || 'Unknown error'}`);
        }
        
        const result = await response.json();
        addLog('テストデータ全削除完了', 'success');
        addLog(`削除結果: ${JSON.stringify(result, null, 2)}`);
        
        // ページをリロードして最新状態を表示
        setTimeout(() => {
          location.reload();
        }, 2000);
        
      } catch (error) {
        addLog('削除エラー: ' + error.message, 'error');
      }
    }
    
    // 退会機能
    async function withdrawUser(email) {
      if (!confirm(`メールアドレス ${email} で退会処理を行いますか？\nこの操作は取り消せません。`)) {
        return;
      }
      
      try {
        addLog(`メールアドレス ${email} で退会処理中...`);
        
        const response = await fetch('https://syugo-sin-worker.mituo0226.workers.dev/api/withdraw', {
          method: 'POST',
          mode: 'cors',
          credentials: 'omit',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ email: email })
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(`退会エラー: ${response.status} - ${errorData.error || 'Unknown error'}`);
        }
        
        const result = await response.json();
        addLog('退会処理完了', 'success');
        addLog(`退会結果: ${JSON.stringify(result, null, 2)}`);
        
        // 退会完了メッセージを表示
        const messageArea = document.getElementById('messageArea');
        messageArea.innerHTML = `
          <div class="success-message">
            退会処理が完了しました！<br>
            メールアドレス: ${result.email}<br>
            ニックネーム: ${result.deleted_user.nickname}<br>
            退会後は同じメールアドレスで再登録が可能になります。
          </div>
        `;
        
        // ページをリロードして最新状態を表示
        setTimeout(() => {
          location.reload();
        }, 3000);
        
      } catch (error) {
        addLog('退会エラー: ' + error.message, 'error');
        const messageArea = document.getElementById('messageArea');
        messageArea.innerHTML = `<div class="error-message">退会処理に失敗しました: ${error.message}</div>`;
      }
    }
    
    // 生年月日入力時のイベントリスナー
    document.addEventListener('DOMContentLoaded', function() {
      const birthdateInput = document.getElementById('birthdate');
      const guardianSelect = document.getElementById('guardianId');
      
      birthdateInput.addEventListener('change', function() {
        const selectedGuardian = getGuardianByBirthdate(this.value);
        if (selectedGuardian) {
          guardianSelect.value = selectedGuardian;
          addLog(`生年月日 ${this.value} に基づいて守護神を自動選択: ${selectedGuardian}`);
        }
      });
    });
    
    // ページ読み込み時の処理
    window.addEventListener('load', function() {
      addLog('会員登録テストページ読み込み完了');
    });
  </script>
</body>
</html>
