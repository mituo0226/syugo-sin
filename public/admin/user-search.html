<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ユーザー検索 | AI鑑定師 龍</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      margin: 0;
      background: #0d0d1a;
      font-family: "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
      color: #fff;
      padding: 20px;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: rgba(13, 13, 26, 0.9);
      border-radius: 20px;
      padding: 40px;
      border: 2px solid rgba(102, 204, 255, 0.4);
    }
    
    .title {
      font-size: 2em;
      color: #66ccff;
      text-align: center;
      margin-bottom: 30px;
    }
    
    .search-section {
      background: rgba(102, 204, 255, 0.1);
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 30px;
      border: 2px solid rgba(102, 204, 255, 0.3);
    }
    
    .search-section h3 {
      color: #66ccff;
      margin-bottom: 15px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: #ccc;
      font-weight: bold;
    }
    
    .form-group input, .form-group select {
      width: 100%;
      padding: 12px;
      border: 1px solid #444;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      font-size: 16px;
      box-sizing: border-box;
    }
    
    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: #66ccff;
      box-shadow: 0 0 10px rgba(102, 204, 255, 0.3);
    }
    
    .form-group select option {
      background: #0d0d1a;
      color: #fff;
    }
    
    .form-group input::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }
    
    .search-button {
      width: 100%;
      padding: 15px;
      font-size: 1.2em;
      background: linear-gradient(90deg, #66ccff, #3399ff);
      border: none;
      border-radius: 15px;
      font-weight: bold;
      cursor: pointer;
      color: #000;
      box-shadow: 0 6px 20px rgba(102,204,255,0.4);
      transition: all 0.3s ease;
      margin-top: 10px;
    }
    
    .search-button:hover {
      background: linear-gradient(90deg, #99e0ff, #66ccff);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102,204,255,0.5);
    }
    
    .search-button:disabled {
      background: #666;
      cursor: not-allowed;
      transform: none;
    }
    
    .result-section {
      background: rgba(13, 13, 26, 0.8);
      padding: 20px;
      border-radius: 10px;
      margin-top: 30px;
      border: 2px solid rgba(102, 204, 255, 0.2);
      display: none;
    }
    
    .result-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: rgba(13, 13, 26, 0.8);
      border-radius: 10px;
      overflow: hidden;
    }
    
    .result-table th, .result-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid rgba(102, 204, 255, 0.2);
    }
    
    .result-table th {
      background: rgba(102, 204, 255, 0.2);
      color: #66ccff;
      font-weight: bold;
    }
    
    .result-table td {
      color: #fff;
    }
    
    .action-buttons {
      margin-top: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .action-button {
      padding: 12px 24px;
      font-size: 1em;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      flex: 1;
      min-width: 120px;
    }
    
    .withdraw-button {
      background: linear-gradient(90deg, #ff6b6b, #ff8e8e);
      color: #fff;
    }
    
    .withdraw-button:hover {
      background: linear-gradient(90deg, #ff5252, #ff6b6b);
      transform: translateY(-2px);
    }
    
    .success-message {
      color: #66ff66;
      margin-top: 20px;
      padding: 15px;
      background: rgba(102, 255, 102, 0.1);
      border-radius: 8px;
      border: 1px solid rgba(102, 255, 102, 0.3);
      text-align: center;
      font-weight: bold;
    }
    
    .error-message {
      color: #ff6b6b;
      margin-top: 20px;
      padding: 15px;
      background: rgba(255, 107, 107, 0.1);
      border-radius: 8px;
      border: 1px solid rgba(255, 107, 107, 0.3);
      text-align: center;
    }
    
    .back-link {
      display: inline-block;
      margin-top: 30px;
      padding: 10px 20px;
      background: rgba(102, 204, 255, 0.2);
      color: #66ccff;
      text-decoration: none;
      border-radius: 8px;
      border: 1px solid rgba(102, 204, 255, 0.4);
      transition: all 0.3s ease;
    }
    
    .back-link:hover {
      background: rgba(102, 204, 255, 0.3);
      transform: translateY(-2px);
    }
    
    .log-area {
      background: rgba(0, 0, 0, 0.5);
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
      font-family: monospace;
      font-size: 14px;
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid rgba(102, 204, 255, 0.2);
    }
    
    .log-entry {
      margin: 5px 0;
      padding: 5px;
      border-radius: 4px;
    }
    
    .log-success {
      background: rgba(102, 255, 102, 0.1);
      color: #66ff66;
    }
    
    .log-error {
      background: rgba(255, 107, 107, 0.1);
      color: #ff6b6b;
    }
    
    .log-info {
      background: rgba(102, 204, 255, 0.1);
      color: #66ccff;
    }
    
    .user-card {
      background: rgba(13, 13, 26, 0.8);
      border: 2px solid rgba(102, 204, 255, 0.3);
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .user-card h4 {
      color: #66ccff;
      margin-top: 0;
      margin-bottom: 15px;
      border-bottom: 1px solid rgba(102, 204, 255, 0.3);
      padding-bottom: 10px;
    }
    
    .user-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .user-info-item {
      background: rgba(102, 204, 255, 0.1);
      padding: 8px 12px;
      border-radius: 5px;
      border: 1px solid rgba(102, 204, 255, 0.2);
    }
    
    .user-info-label {
      font-weight: bold;
      color: #66ccff;
      font-size: 0.9em;
    }
    
    .user-info-value {
      color: #fff;
      margin-top: 2px;
    }
    
    .user-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .user-withdraw-button {
      padding: 8px 16px;
      background: linear-gradient(90deg, #ff6b6b, #ff8e8e);
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9em;
      transition: all 0.3s ease;
    }
    
    .user-withdraw-button:hover {
      background: linear-gradient(90deg, #ff5252, #ff6b6b);
      transform: translateY(-1px);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="title">ユーザー検索</h1>
    
    <!-- 検索セクション -->
    <div class="search-section">
      <h3>ユーザー検索</h3>
      <form id="searchForm">
        <div class="form-group">
          <label for="searchType">検索タイプ</label>
          <select id="searchType" name="searchType" required>
            <option value="">検索タイプを選択してください</option>
            <option value="email">メールアドレス</option>
            <option value="nickname">ニックネーム</option>
            <option value="birthdate">生年月日</option>
            <option value="multiple">複数条件</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="email">メールアドレス</label>
          <input type="email" id="email" name="email" placeholder="user@example.com">
        </div>
        
        <div class="form-group">
          <label for="nickname">ニックネーム</label>
          <input type="text" id="nickname" name="nickname" placeholder="ニックネーム">
        </div>
        
        <div class="form-group">
          <label for="birthdate">生年月日</label>
          <input type="date" id="birthdate" name="birthdate">
        </div>
        
        <button type="submit" class="search-button" id="searchButton">
          ユーザーを検索
        </button>
      </form>
    </div>
    
    <!-- 結果表示セクション -->
    <div id="resultSection" class="result-section">
      <h3 style="color: #66ccff;">検索結果</h3>
      <div id="resultCount" style="color: #66ccff; margin-bottom: 15px;"></div>
      <div id="usersContainer">
        <!-- ユーザー一覧がここに動的に生成されます -->
      </div>
    </div>
    
    <!-- メッセージ表示エリア -->
    <div id="messageArea"></div>
    
    <!-- ログ表示エリア -->
    <div class="log-area" id="logArea">
      <div class="log-entry log-info">ログがここに表示されます...</div>
    </div>
    
    <!-- 管理画面に戻るリンク -->
    <a href="admin.html" class="back-link">← 管理画面に戻る</a>
  </div>

  <script>
    // ログ表示関数
    function addLog(message, type = 'info') {
      const logArea = document.getElementById('logArea');
      const logEntry = document.createElement('div');
      logEntry.className = `log-entry log-${type}`;
      logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logArea.appendChild(logEntry);
      logArea.scrollTop = logArea.scrollHeight;
      
      // コンソールにも出力
      if (type === 'error') {
        console.error(message);
      } else if (type === 'success') {
        console.log(message);
      } else {
        console.log(message);
      }
    }
    
    let currentUsers = [];
    
    // 検索タイプ変更時の処理
    document.getElementById('searchType').addEventListener('change', function() {
      const searchType = this.value;
      const emailField = document.getElementById('email');
      const nicknameField = document.getElementById('nickname');
      const birthdateField = document.getElementById('birthdate');
      
      // すべてのフィールドをリセット
      emailField.value = '';
      nicknameField.value = '';
      birthdateField.value = '';
      
      // 検索タイプに応じてフィールドを有効/無効化
      if (searchType === 'email') {
        emailField.required = true;
        nicknameField.required = false;
        birthdateField.required = false;
      } else if (searchType === 'nickname') {
        emailField.required = false;
        nicknameField.required = true;
        birthdateField.required = false;
      } else if (searchType === 'birthdate') {
        emailField.required = false;
        nicknameField.required = false;
        birthdateField.required = true;
      } else if (searchType === 'multiple') {
        emailField.required = false;
        nicknameField.required = false;
        birthdateField.required = false;
      }
    });
    
    // フォーム送信処理
    document.getElementById('searchForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const searchButton = document.getElementById('searchButton');
      const messageArea = document.getElementById('messageArea');
      const resultSection = document.getElementById('resultSection');
      
      // ボタンを無効化
      searchButton.disabled = true;
      searchButton.textContent = '検索中...';
      
      // メッセージエリアと結果セクションをクリア
      messageArea.innerHTML = '';
      resultSection.style.display = 'none';
      
      try {
        // フォームデータを取得
        const searchType = document.getElementById('searchType').value;
        const email = document.getElementById('email').value.trim();
        const nickname = document.getElementById('nickname').value.trim();
        const birthdate = document.getElementById('birthdate').value;
        
        // バリデーション
        if (!searchType) {
          throw new Error('検索タイプを選択してください');
        }
        
        if (searchType === 'email' && !email) {
          throw new Error('メールアドレスを入力してください');
        }
        if (searchType === 'nickname' && !nickname) {
          throw new Error('ニックネームを入力してください');
        }
        if (searchType === 'birthdate' && !birthdate) {
          throw new Error('生年月日を入力してください');
        }
        if (searchType === 'multiple' && !email && !nickname && !birthdate) {
          throw new Error('少なくとも1つの検索条件を入力してください');
        }
        
        addLog(`ユーザー検索開始: タイプ=${searchType}, email=${email}, nickname=${nickname}, birthdate=${birthdate}`);
        
        // APIに送信
        const response = await fetch('https://syugo-sin-worker.mituo0226.workers.dev/api/search-user', {
          method: 'POST',
          mode: 'cors',
          credentials: 'omit',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ 
            email: email,
            nickname: nickname,
            birthdate: birthdate,
            searchType: searchType
          })
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          if (response.status === 404) {
            throw new Error('ユーザーが見つかりませんでした');
          }
          throw new Error(`検索エラー: ${response.status} - ${errorData.error || 'Unknown error'}`);
        }
        
        const result = await response.json();
        currentUsers = result.users;
        
        addLog('ユーザー検索完了', 'success');
        addLog(`検索結果: ${result.count}件のユーザーが見つかりました`);
        
        // 成功メッセージを表示
        messageArea.innerHTML = `<div class="success-message">${result.count}件のユーザーが見つかりました！</div>`;
        
        // 検索結果を表示
        displayUsers(currentUsers);
        
        // 結果セクションを表示
        resultSection.style.display = 'block';
        
      } catch (error) {
        addLog('検索エラー: ' + error.message, 'error');
        messageArea.innerHTML = `<div class="error-message">検索に失敗しました: ${error.message}</div>`;
      } finally {
        // ボタンを有効化
        searchButton.disabled = false;
        searchButton.textContent = 'ユーザーを検索';
      }
    });
    
    // ユーザー一覧を表示する関数
    function displayUsers(users) {
      const resultCount = document.getElementById('resultCount');
      const usersContainer = document.getElementById('usersContainer');
      
      resultCount.textContent = `検索結果: ${users.length}件のユーザーが見つかりました`;
      usersContainer.innerHTML = '';
      
      users.forEach((user, index) => {
        const userCard = document.createElement('div');
        userCard.className = 'user-card';
        userCard.innerHTML = `
          <h4>ユーザー ${index + 1} (ID: ${user.id})</h4>
          <div class="user-info">
            <div class="user-info-item">
              <div class="user-info-label">メールアドレス</div>
              <div class="user-info-value">${user.email}</div>
            </div>
            <div class="user-info-item">
              <div class="user-info-label">ニックネーム</div>
              <div class="user-info-value">${user.nickname}</div>
            </div>
            <div class="user-info-item">
              <div class="user-info-label">生年月日</div>
              <div class="user-info-value">${user.birthdate || '未設定'}</div>
            </div>
            <div class="user-info-item">
              <div class="user-info-label">守護神ID</div>
              <div class="user-info-value">${user.guardian_id || '未設定'}</div>
            </div>
            <div class="user-info-item">
              <div class="user-info-label">テーマ</div>
              <div class="user-info-value">${user.theme || '未設定'}</div>
            </div>
            <div class="user-info-item">
              <div class="user-info-label">登録日時</div>
              <div class="user-info-value">${user.created_at}</div>
            </div>
          </div>
          <div class="user-actions">
            <button class="user-withdraw-button" onclick="withdrawUser('${user.email}', ${user.id})">
              このユーザーを退会
            </button>
          </div>
        `;
        usersContainer.appendChild(userCard);
      });
    }
    
    // 個別ユーザーの退会処理
    async function withdrawUser(email, userId) {
      if (!confirm(`メールアドレス ${email} (ID: ${userId}) で退会処理を行いますか？\nこの操作は取り消せません。`)) {
        return;
      }
      
      try {
        addLog(`退会処理開始: ${email} (ID: ${userId})`);
        
        const response = await fetch('https://syugo-sin-worker.mituo0226.workers.dev/api/withdraw', {
          method: 'POST',
          mode: 'cors',
          credentials: 'omit',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ email: email })
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(`退会エラー: ${response.status} - ${errorData.error || 'Unknown error'}`);
        }
        
        const result = await response.json();
        addLog('退会処理完了', 'success');
        addLog(`退会結果: ${JSON.stringify(result, null, 2)}`);
        
        // 退会完了メッセージを表示
        const messageArea = document.getElementById('messageArea');
        messageArea.innerHTML = `
          <div class="success-message">
            退会処理が完了しました！<br>
            メールアドレス: ${result.email}<br>
            ニックネーム: ${result.deleted_user.nickname}<br>
            退会後は同じメールアドレスで再登録が可能になります。
          </div>
        `;
        
        // 検索結果から該当ユーザーを削除
        currentUsers = currentUsers.filter(user => user.id !== userId);
        
        if (currentUsers.length === 0) {
          // 全ユーザーが退会した場合
          document.getElementById('resultSection').style.display = 'none';
          messageArea.innerHTML = `
            <div class="success-message">
              退会処理が完了しました！<br>
              メールアドレス: ${result.email}<br>
              ニックネーム: ${result.deleted_user.nickname}<br>
              検索結果に該当するユーザーはすべて退会しました。
            </div>
          `;
        } else {
          // まだ他のユーザーがいる場合、一覧を更新
          displayUsers(currentUsers);
          messageArea.innerHTML = `
            <div class="success-message">
              退会処理が完了しました！<br>
              メールアドレス: ${result.email}<br>
              ニックネーム: ${result.deleted_user.nickname}<br>
              残りのユーザー: ${currentUsers.length}件
            </div>
          `;
        }
        
      } catch (error) {
        addLog('退会エラー: ' + error.message, 'error');
        const messageArea = document.getElementById('messageArea');
        messageArea.innerHTML = `<div class="error-message">退会処理に失敗しました: ${error.message}</div>`;
      }
    }
    
    // ページ読み込み時の処理
    window.addEventListener('load', function() {
      addLog('ユーザー検索ページ読み込み完了');
    });
  </script>
</body>
</html>
