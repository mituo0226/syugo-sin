<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>„É¶„Éº„Ç∂„ÉºÊ§úÁ¥¢ | AIÈëëÂÆöÂ∏´ Èæç</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      margin: 0;
      background: #0d0d1a;
      font-family: "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
      color: #fff;
      padding: 20px;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: rgba(13, 13, 26, 0.9);
      border-radius: 20px;
      padding: 40px;
      border: 2px solid rgba(102, 204, 255, 0.4);
    }
    
    .title {
      font-size: 2em;
      color: #66ccff;
      text-align: center;
      margin-bottom: 30px;
    }
    
    .search-section {
      background: rgba(102, 204, 255, 0.1);
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 30px;
      border: 2px solid rgba(102, 204, 255, 0.3);
    }
    
    .search-section h3 {
      color: #66ccff;
      margin-bottom: 15px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: #ccc;
      font-weight: bold;
    }
    
    .form-group input, .form-group select {
      width: 100%;
      padding: 12px;
      border: 1px solid #444;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      font-size: 16px;
      box-sizing: border-box;
    }
    
    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: #66ccff;
      box-shadow: 0 0 10px rgba(102, 204, 255, 0.3);
    }
    
    .form-group select option {
      background: #0d0d1a;
      color: #fff;
    }
    
    .form-group input::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }
    
    .search-button {
      width: 100%;
      padding: 15px;
      font-size: 1.2em;
      background: linear-gradient(90deg, #66ccff, #3399ff);
      border: none;
      border-radius: 15px;
      font-weight: bold;
      cursor: pointer;
      color: #000;
      box-shadow: 0 6px 20px rgba(102,204,255,0.4);
      transition: all 0.3s ease;
      margin-top: 10px;
    }
    
    .search-button:hover {
      background: linear-gradient(90deg, #99e0ff, #66ccff);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102,204,255,0.5);
    }
    
    .search-button:disabled {
      background: #666;
      cursor: not-allowed;
      transform: none;
    }
    
    .result-section {
      background: rgba(13, 13, 26, 0.8);
      padding: 20px;
      border-radius: 10px;
      margin-top: 30px;
      border: 2px solid rgba(102, 204, 255, 0.2);
      display: none;
    }
    
    .result-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: rgba(13, 13, 26, 0.8);
      border-radius: 10px;
      overflow: hidden;
    }
    
    .result-table th, .result-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid rgba(102, 204, 255, 0.2);
    }
    
    .result-table th {
      background: rgba(102, 204, 255, 0.2);
      color: #66ccff;
      font-weight: bold;
    }
    
    .result-table td {
      color: #fff;
    }
    
    .action-buttons {
      margin-top: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .action-button {
      padding: 12px 24px;
      font-size: 1em;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      flex: 1;
      min-width: 120px;
    }
    
    .withdraw-button {
      background: linear-gradient(90deg, #ff6b6b, #ff8e8e);
      color: #fff;
    }
    
    .withdraw-button:hover {
      background: linear-gradient(90deg, #ff5252, #ff6b6b);
      transform: translateY(-2px);
    }
    
    .success-message {
      color: #66ff66;
      margin-top: 20px;
      padding: 15px;
      background: rgba(102, 255, 102, 0.1);
      border-radius: 8px;
      border: 1px solid rgba(102, 255, 102, 0.3);
      text-align: center;
      font-weight: bold;
    }
    
    .error-message {
      color: #ff6b6b;
      margin-top: 20px;
      padding: 15px;
      background: rgba(255, 107, 107, 0.1);
      border-radius: 8px;
      border: 1px solid rgba(255, 107, 107, 0.3);
      text-align: center;
    }
    
    .back-link {
      display: inline-block;
      margin-top: 30px;
      padding: 10px 20px;
      background: rgba(102, 204, 255, 0.2);
      color: #66ccff;
      text-decoration: none;
      border-radius: 8px;
      border: 1px solid rgba(102, 204, 255, 0.4);
      transition: all 0.3s ease;
    }
    
    .back-link:hover {
      background: rgba(102, 204, 255, 0.3);
      transform: translateY(-2px);
    }
    
    .log-area {
      background: rgba(0, 0, 0, 0.5);
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
      font-family: monospace;
      font-size: 14px;
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid rgba(102, 204, 255, 0.2);
    }
    
    .log-entry {
      margin: 5px 0;
      padding: 5px;
      border-radius: 4px;
    }
    
    .log-success {
      background: rgba(102, 255, 102, 0.1);
      color: #66ff66;
    }
    
    .log-error {
      background: rgba(255, 107, 107, 0.1);
      color: #ff6b6b;
    }
    
    .log-info {
      background: rgba(102, 204, 255, 0.1);
      color: #66ccff;
    }
    
    .user-card {
      background: rgba(13, 13, 26, 0.8);
      border: 2px solid rgba(102, 204, 255, 0.3);
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .user-card h4 {
      color: #66ccff;
      margin-top: 0;
      margin-bottom: 15px;
      border-bottom: 1px solid rgba(102, 204, 255, 0.3);
      padding-bottom: 10px;
    }
    
    .user-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .user-info-item {
      background: rgba(102, 204, 255, 0.1);
      padding: 8px 12px;
      border-radius: 5px;
      border: 1px solid rgba(102, 204, 255, 0.2);
    }
    
    .user-info-label {
      font-weight: bold;
      color: #66ccff;
      font-size: 0.9em;
    }
    
    .user-info-value {
      color: #fff;
      margin-top: 2px;
    }
    
    .user-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .user-withdraw-button {
      padding: 8px 16px;
      background: linear-gradient(90deg, #ff6b6b, #ff8e8e);
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9em;
      transition: all 0.3s ease;
    }
    
    .user-withdraw-button:hover {
      background: linear-gradient(90deg, #ff5252, #ff6b6b);
      transform: translateY(-1px);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="title">„É¶„Éº„Ç∂„ÉºÊ§úÁ¥¢</h1>
    
    <!-- Ê§úÁ¥¢„Çª„ÇØ„Ç∑„Éß„É≥ -->
    <div class="search-section">
      <h3>„É¶„Éº„Ç∂„ÉºÊ§úÁ¥¢</h3>
      <form id="searchForm">
        <div class="form-group">
          <label for="searchType">Ê§úÁ¥¢„Çø„Ç§„Éó</label>
          <select id="searchType" name="searchType" required>
            <option value="">Ê§úÁ¥¢„Çø„Ç§„Éó„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
            <option value="email">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</option>
            <option value="nickname">„Éã„ÉÉ„ÇØ„Éç„Éº„É†</option>
            <option value="birthdate">ÁîüÂπ¥ÊúàÊó•</option>
            <option value="multiple">Ë§áÊï∞Êù°‰ª∂</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="email">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
          <input type="email" id="email" name="email" placeholder="user@example.com">
        </div>
        
        <div class="form-group">
          <label for="nickname">„Éã„ÉÉ„ÇØ„Éç„Éº„É†</label>
          <input type="text" id="nickname" name="nickname" placeholder="„Éã„ÉÉ„ÇØ„Éç„Éº„É†">
        </div>
        
        <div class="form-group">
          <label for="birthdate">ÁîüÂπ¥ÊúàÊó•</label>
          <input type="date" id="birthdate" name="birthdate">
        </div>
        
        <button type="submit" class="search-button" id="searchButton">
          „É¶„Éº„Ç∂„Éº„ÇíÊ§úÁ¥¢
        </button>
        <button type="button" onclick="debugDatabase()" class="search-button" style="margin-left: 10px; background: linear-gradient(90deg, #6c757d, #495057);">
          üîß DBÁä∂ÊÖãÁ¢∫Ë™ç
        </button>
        <button type="button" onclick="inspectDatabase()" class="search-button" style="margin-left: 10px; background: linear-gradient(90deg, #9d4edd, #7b2cbf);">
          üîç DBË©≥Á¥∞Ë™øÊüª
        </button>
      </form>
    </div>
    
    <!-- ÁµêÊûúË°®Á§∫„Çª„ÇØ„Ç∑„Éß„É≥ -->
    <div id="resultSection" class="result-section">
      <h3 style="color: #66ccff;">Ê§úÁ¥¢ÁµêÊûú</h3>
      <div id="resultCount" style="color: #66ccff; margin-bottom: 15px;"></div>
      <div id="usersContainer">
        <!-- „É¶„Éº„Ç∂„Éº‰∏ÄË¶ß„Åå„Åì„Åì„Å´ÂãïÁöÑ„Å´ÁîüÊàê„Åï„Çå„Åæ„Åô -->
      </div>
    </div>
    
    <!-- „É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫„Ç®„É™„Ç¢ -->
    <div id="messageArea"></div>
    
    <!-- „É≠„Ç∞Ë°®Á§∫„Ç®„É™„Ç¢ -->
    <div class="log-area" id="logArea">
      <div class="log-entry log-info">„É≠„Ç∞„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô...</div>
    </div>
    
    <!-- ÁÆ°ÁêÜÁîªÈù¢„Å´Êàª„Çã„É™„É≥„ÇØ -->
    <a href="admin.html" class="back-link">‚Üê ÁÆ°ÁêÜÁîªÈù¢„Å´Êàª„Çã</a>
  </div>

  <script>
    // „É≠„Ç∞Ë°®Á§∫Èñ¢Êï∞
    function addLog(message, type = 'info') {
      const logArea = document.getElementById('logArea');
      const logEntry = document.createElement('div');
      logEntry.className = `log-entry log-${type}`;
      logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logArea.appendChild(logEntry);
      logArea.scrollTop = logArea.scrollHeight;
      
      // „Ç≥„É≥„ÇΩ„Éº„É´„Å´„ÇÇÂá∫Âäõ
      if (type === 'error') {
        console.error(message);
      } else if (type === 'success') {
        console.log(message);
      } else {
        console.log(message);
      }
    }
    
    let currentUsers = [];
    
    // Ê§úÁ¥¢„Çø„Ç§„ÉóÂ§âÊõ¥ÊôÇ„ÅÆÂá¶ÁêÜ
    document.getElementById('searchType').addEventListener('change', function() {
      const searchType = this.value;
      const emailField = document.getElementById('email');
      const nicknameField = document.getElementById('nickname');
      const birthdateField = document.getElementById('birthdate');
      
      // „Åô„Åπ„Å¶„ÅÆ„Éï„Ç£„Éº„É´„Éâ„Çí„É™„Çª„ÉÉ„Éà
      emailField.value = '';
      nicknameField.value = '';
      birthdateField.value = '';
      
      // Ê§úÁ¥¢„Çø„Ç§„Éó„Å´Âøú„Åò„Å¶„Éï„Ç£„Éº„É´„Éâ„ÇíÊúâÂäπ/ÁÑ°ÂäπÂåñ
      if (searchType === 'email') {
        emailField.required = true;
        nicknameField.required = false;
        birthdateField.required = false;
      } else if (searchType === 'nickname') {
        emailField.required = false;
        nicknameField.required = true;
        birthdateField.required = false;
      } else if (searchType === 'birthdate') {
        emailField.required = false;
        nicknameField.required = false;
        birthdateField.required = true;
      } else if (searchType === 'multiple') {
        emailField.required = false;
        nicknameField.required = false;
        birthdateField.required = false;
      }
    });
    
    // „Éï„Ç©„Éº„É†ÈÄÅ‰ø°Âá¶ÁêÜ
    document.getElementById('searchForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const searchButton = document.getElementById('searchButton');
      const messageArea = document.getElementById('messageArea');
      const resultSection = document.getElementById('resultSection');
      
      // „Éú„Çø„É≥„ÇíÁÑ°ÂäπÂåñ
      searchButton.disabled = true;
      searchButton.textContent = 'Ê§úÁ¥¢‰∏≠...';
      
      // „É°„ÉÉ„Çª„Éº„Ç∏„Ç®„É™„Ç¢„Å®ÁµêÊûú„Çª„ÇØ„Ç∑„Éß„É≥„Çí„ÇØ„É™„Ç¢
      messageArea.innerHTML = '';
      resultSection.style.display = 'none';
      
      try {
        // „Éï„Ç©„Éº„É†„Éá„Éº„Çø„ÇíÂèñÂæó
        const searchType = document.getElementById('searchType').value;
        const email = document.getElementById('email').value.trim();
        const nickname = document.getElementById('nickname').value.trim();
        const birthdate = document.getElementById('birthdate').value;
        
        // „Éê„É™„Éá„Éº„Ç∑„Éß„É≥
        if (!searchType) {
          throw new Error('Ê§úÁ¥¢„Çø„Ç§„Éó„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        }
        
        if (searchType === 'email' && !email) {
          throw new Error('„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        }
        if (searchType === 'nickname' && !nickname) {
          throw new Error('„Éã„ÉÉ„ÇØ„Éç„Éº„É†„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        }
        if (searchType === 'birthdate' && !birthdate) {
          throw new Error('ÁîüÂπ¥ÊúàÊó•„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        }
        if (searchType === 'multiple' && !email && !nickname && !birthdate) {
          throw new Error('Â∞ë„Å™„Åè„Å®„ÇÇ1„Å§„ÅÆÊ§úÁ¥¢Êù°‰ª∂„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        }
        
        addLog(`„É¶„Éº„Ç∂„ÉºÊ§úÁ¥¢ÈñãÂßã: „Çø„Ç§„Éó=${searchType}, email=${email}, nickname=${nickname}, birthdate=${birthdate}`);
        
        // API„Å´ÈÄÅ‰ø°
        const response = await fetch('/api/search-user', {
          method: 'POST',
          mode: 'cors',
          credentials: 'omit',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ 
            email: email,
            nickname: nickname,
            birthdate: birthdate,
            searchType: searchType
          })
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          if (response.status === 404) {
            throw new Error('Ê§úÁ¥¢„Åï„Çå„Åü„É¶„Éº„Ç∂„Éº„ÅØÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
          }
          throw new Error(`Ê§úÁ¥¢„Ç®„É©„Éº: ${response.status} - ${errorData.error || 'Unknown error'}`);
        }
        
        const result = await response.json();
        currentUsers = result.users;
        
        addLog('„É¶„Éº„Ç∂„ÉºÊ§úÁ¥¢ÂÆå‰∫Ü', 'success');
        addLog(`Ê§úÁ¥¢ÁµêÊûú: ${result.count}‰ª∂„ÅÆ„É¶„Éº„Ç∂„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åó„Åü`);
        
        // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
        messageArea.innerHTML = `<div class="success-message">${result.count}‰ª∂„ÅÆ„É¶„Éº„Ç∂„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åó„ÅüÔºÅ</div>`;
        
        // Ê§úÁ¥¢ÁµêÊûú„ÇíË°®Á§∫
        displayUsers(currentUsers);
        
        // ÁµêÊûú„Çª„ÇØ„Ç∑„Éß„É≥„ÇíË°®Á§∫
        resultSection.style.display = 'block';
        
      } catch (error) {
        addLog('Ê§úÁ¥¢„Ç®„É©„Éº: ' + error.message, 'error');
        messageArea.innerHTML = `<div class="error-message">Ê§úÁ¥¢„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}</div>`;
      } finally {
        // „Éú„Çø„É≥„ÇíÊúâÂäπÂåñ
        searchButton.disabled = false;
        searchButton.textContent = '„É¶„Éº„Ç∂„Éº„ÇíÊ§úÁ¥¢';
      }
    });
    
    // „É¶„Éº„Ç∂„Éº‰∏ÄË¶ß„ÇíË°®Á§∫„Åô„ÇãÈñ¢Êï∞
    function displayUsers(users) {
      const resultCount = document.getElementById('resultCount');
      const usersContainer = document.getElementById('usersContainer');
      
      resultCount.textContent = `Ê§úÁ¥¢ÁµêÊûú: ${users.length}‰ª∂„ÅÆ„É¶„Éº„Ç∂„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åó„Åü`;
      usersContainer.innerHTML = '';
      
      users.forEach((user, index) => {
        const userCard = document.createElement('div');
        userCard.className = 'user-card';
        userCard.innerHTML = `
          <h4>„É¶„Éº„Ç∂„Éº ${index + 1} (ID: ${user.id})</h4>
          <div class="user-info">
            <div class="user-info-item">
              <div class="user-info-label">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</div>
              <div class="user-info-value">${user.email}</div>
            </div>
            <div class="user-info-item">
              <div class="user-info-label">„Éã„ÉÉ„ÇØ„Éç„Éº„É†</div>
              <div class="user-info-value">${user.nickname}</div>
            </div>
            <div class="user-info-item">
              <div class="user-info-label">ÁîüÂπ¥ÊúàÊó•</div>
              <div class="user-info-value">${user.birthdate || 'Êú™Ë®≠ÂÆö'}</div>
            </div>
            <div class="user-info-item">
              <div class="user-info-label">ÂÆàË≠∑Á•ûID</div>
              <div class="user-info-value">${user.guardian_id || 'Êú™Ë®≠ÂÆö'}</div>
            </div>
            <div class="user-info-item">
              <div class="user-info-label">„ÉÜ„Éº„Éû</div>
              <div class="user-info-value">${user.theme || 'Êú™Ë®≠ÂÆö'}</div>
            </div>
            <div class="user-info-item">
              <div class="user-info-label">ÁôªÈå≤Êó•ÊôÇ</div>
              <div class="user-info-value">${user.created_at}</div>
            </div>
          </div>
          <div class="user-actions">
            <button class="user-withdraw-button" onclick="withdrawUser('${user.email}', ${user.id})">
              „Åì„ÅÆ„É¶„Éº„Ç∂„Éº„ÇíÈÄÄ‰ºö
            </button>
          </div>
        `;
        usersContainer.appendChild(userCard);
      });
    }
    
    // ÂÄãÂà•„É¶„Éº„Ç∂„Éº„ÅÆÈÄÄ‰ºöÂá¶ÁêÜ
    async function withdrawUser(email, userId) {
      if (!confirm(`„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ ${email} (ID: ${userId}) „ÅßÈÄÄ‰ºöÂá¶ÁêÜ„ÇíË°å„ÅÑ„Åæ„Åô„ÅãÔºü\n„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ`)) {
        return;
      }
      
      try {
        addLog(`ÈÄÄ‰ºöÂá¶ÁêÜÈñãÂßã: ${email} (ID: ${userId})`);
        
        const response = await fetch('/api/withdraw', {
          method: 'POST',
          mode: 'cors',
          credentials: 'omit',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ email: email })
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(`ÈÄÄ‰ºö„Ç®„É©„Éº: ${response.status} - ${errorData.error || 'Unknown error'}`);
        }
        
        const result = await response.json();
        addLog('ÈÄÄ‰ºöÂá¶ÁêÜÂÆå‰∫Ü', 'success');
        addLog(`ÈÄÄ‰ºöÁµêÊûú: ${JSON.stringify(result, null, 2)}`);
        
        // ÈÄÄ‰ºöÂÆå‰∫Ü„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
        const messageArea = document.getElementById('messageArea');
        messageArea.innerHTML = `
          <div class="success-message">
            ÈÄÄ‰ºöÂá¶ÁêÜ„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ<br>
            „É°„Éº„É´„Ç¢„Éâ„É¨„Çπ: ${result.email}<br>
            „Éã„ÉÉ„ÇØ„Éç„Éº„É†: ${result.deleted_user.nickname}<br>
            ÈÄÄ‰ºöÂæå„ÅØÂêå„Åò„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅßÂÜçÁôªÈå≤„ÅåÂèØËÉΩ„Å´„Å™„Çä„Åæ„Åô„ÄÇ
          </div>
        `;
        
        // Ê§úÁ¥¢ÁµêÊûú„Åã„ÇâË©≤ÂΩì„É¶„Éº„Ç∂„Éº„ÇíÂâäÈô§
        currentUsers = currentUsers.filter(user => user.id !== userId);
        
        if (currentUsers.length === 0) {
          // ÂÖ®„É¶„Éº„Ç∂„Éº„ÅåÈÄÄ‰ºö„Åó„ÅüÂ†¥Âêà
          document.getElementById('resultSection').style.display = 'none';
          messageArea.innerHTML = `
            <div class="success-message">
              ÈÄÄ‰ºöÂá¶ÁêÜ„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ<br>
              „É°„Éº„É´„Ç¢„Éâ„É¨„Çπ: ${result.email}<br>
              „Éã„ÉÉ„ÇØ„Éç„Éº„É†: ${result.deleted_user.nickname}<br>
              Ê§úÁ¥¢ÁµêÊûú„Å´Ë©≤ÂΩì„Åô„Çã„É¶„Éº„Ç∂„Éº„ÅØ„Åô„Åπ„Å¶ÈÄÄ‰ºö„Åó„Åæ„Åó„Åü„ÄÇ
            </div>
          `;
        } else {
          // „Åæ„Å†‰ªñ„ÅÆ„É¶„Éº„Ç∂„Éº„Åå„ÅÑ„ÇãÂ†¥Âêà„ÄÅ‰∏ÄË¶ß„ÇíÊõ¥Êñ∞
          displayUsers(currentUsers);
          messageArea.innerHTML = `
            <div class="success-message">
              ÈÄÄ‰ºöÂá¶ÁêÜ„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ<br>
              „É°„Éº„É´„Ç¢„Éâ„É¨„Çπ: ${result.email}<br>
              „Éã„ÉÉ„ÇØ„Éç„Éº„É†: ${result.deleted_user.nickname}<br>
              ÊÆã„Çä„ÅÆ„É¶„Éº„Ç∂„Éº: ${currentUsers.length}‰ª∂
            </div>
          `;
        }
        
      } catch (error) {
        addLog('ÈÄÄ‰ºö„Ç®„É©„Éº: ' + error.message, 'error');
        const messageArea = document.getElementById('messageArea');
        messageArea.innerHTML = `<div class="error-message">ÈÄÄ‰ºöÂá¶ÁêÜ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}</div>`;
      }
    }
    
    // „Éá„Éº„Çø„Éô„Éº„Çπ„Éá„Éê„ÉÉ„Ç∞Ê©üËÉΩ
    async function debugDatabase() {
      try {
        addLog('„Éá„Éº„Çø„Éô„Éº„ÇπÁä∂ÊÖãÁ¢∫Ë™ç‰∏≠...');
        
        const response = await fetch('/api/debug-db', {
          method: 'POST',
          mode: 'cors',
          credentials: 'omit',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({})
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(`„Éá„Éê„ÉÉ„Ç∞„Ç®„É©„Éº: ${response.status} - ${errorData.error || 'Unknown error'}`);
        }
        
        const result = await response.json();
        addLog('„Éá„Éº„Çø„Éô„Éº„ÇπÁä∂ÊÖãÁ¢∫Ë™çÂÆå‰∫Ü', 'success');
        
        // „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±„ÇíË°®Á§∫
        const messageArea = document.getElementById('messageArea');
        messageArea.innerHTML = `
          <div class="success-message">
            <h4>„Éá„Éº„Çø„Éô„Éº„ÇπÁä∂ÊÖã</h4>
            <p><strong>„Éá„Éº„Çø„Éô„Éº„Çπ„Éê„Ç§„É≥„Éâ:</strong> ${result.database_bound ? 'OK' : 'NG'}</p>
            <p><strong>„ÉÜ„Éº„Éñ„É´Êï∞:</strong> ${result.tables.length}ÂÄã</p>
            <p><strong>„É¶„Éº„Ç∂„ÉºÊï∞:</strong> ${result.user_count}‰ª∂</p>
            <p><strong>„ÉÜ„Çπ„Éà„É¶„Éº„Ç∂„Éº:</strong> ${result.test_user ? 'Â≠òÂú®' : '‰∏çÂ≠òÂú®'}</p>
            <p><strong>Â§ñÈÉ®„Ç≠„ÉºÂà∂Á¥Ñ:</strong> ${result.foreign_keys_enabled ? 'ÊúâÂäπ' : 'ÁÑ°Âäπ'}</p>
            ${result.all_foreign_keys.length > 0 ? `<p><strong>Â§ñÈÉ®„Ç≠„ÉºÂà∂Á¥Ñ:</strong> ${result.all_foreign_keys.length}ÂÄã„ÅÆ„ÉÜ„Éº„Éñ„É´„ÅßÂà∂Á¥Ñ„ÅÇ„Çä</p>` : ''}
            <details style="margin-top: 10px;">
              <summary>„ÉÜ„Éº„Éñ„É´‰∏ÄË¶ß</summary>
              <ul style="margin: 5px 0;">
                ${result.tables.map(table => `<li>${table.name}</li>`).join('')}
              </ul>
            </details>
            ${result.all_foreign_keys.length > 0 ? `
            <details style="margin-top: 10px;">
              <summary>Â§ñÈÉ®„Ç≠„ÉºÂà∂Á¥Ñ</summary>
              <ul style="margin: 5px 0;">
                ${result.all_foreign_keys.map(fk => 
                  `<li><strong>${fk.table}:</strong> ${fk.foreign_keys.map(key => 
                    `${key.from} ‚Üí ${key.table}.${key.to}`
                  ).join(', ')}</li>`
                ).join('')}
              </ul>
            </details>
            ` : ''}
            <details style="margin-top: 10px;">
              <summary>Ë©≥Á¥∞ÊÉÖÂ†±</summary>
              <pre style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; overflow-x: auto; font-size: 12px;">${JSON.stringify(result, null, 2)}</pre>
            </details>
          </div>
        `;
        
      } catch (error) {
        addLog('„Éá„Éê„ÉÉ„Ç∞„Ç®„É©„Éº: ' + error.message, 'error');
        const messageArea = document.getElementById('messageArea');
        messageArea.innerHTML = `<div class="error-message">„Éá„Éê„ÉÉ„Ç∞Âá¶ÁêÜ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}</div>`;
      }
    }
    
    // „Éá„Éº„Çø„Éô„Éº„ÇπË©≥Á¥∞Ë™øÊüªÊ©üËÉΩ
    async function inspectDatabase() {
      try {
        addLog('„Éá„Éº„Çø„Éô„Éº„ÇπË©≥Á¥∞Ë™øÊüª‰∏≠...');
        
        const response = await fetch('/api/inspect-db', {
          method: 'POST',
          mode: 'cors',
          credentials: 'omit',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({})
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(`Ë™øÊüª„Ç®„É©„Éº: ${response.status} - ${errorData.error || 'Unknown error'}`);
        }
        
        const result = await response.json();
        addLog('„Éá„Éº„Çø„Éô„Éº„ÇπË©≥Á¥∞Ë™øÊüªÂÆå‰∫Ü', 'success');
        
        // Ë™øÊüªÁµêÊûú„ÇíË°®Á§∫
        const messageArea = document.getElementById('messageArea');
        messageArea.innerHTML = `
          <div class="success-message">
            <h4>„Éá„Éº„Çø„Éô„Éº„ÇπË©≥Á¥∞Ë™øÊüªÁµêÊûú</h4>
            <p><strong>„ÉÜ„Éº„Éñ„É´Êï∞:</strong> ${result.tables.length}ÂÄã</p>
            <p><strong>Â§ñÈÉ®„Ç≠„ÉºÂà∂Á¥Ñ:</strong> ${result.foreignKeysEnabled ? 'ÊúâÂäπ' : 'ÁÑ°Âäπ'}</p>
            <p><strong>users„ÉÜ„Éº„Éñ„É´„Å∏„ÅÆÂèÇÁÖß:</strong> ${result.referencesToUsers.length}ÂÄã</p>
            
            <details style="margin-top: 10px;">
              <summary>„ÉÜ„Éº„Éñ„É´‰∏ÄË¶ß„Å®„É¨„Ç≥„Éº„ÉâÊï∞</summary>
              <ul style="margin: 5px 0;">
                ${Object.keys(result.tableSchemas).map(tableName => {
                  const schema = result.tableSchemas[tableName];
                  const count = schema.recordCount !== undefined ? schema.recordCount : '?';
                  const fkCount = schema.foreignKeys ? schema.foreignKeys.length : 0;
                  return `<li><strong>${tableName}:</strong> ${count}‰ª∂ ${fkCount > 0 ? `(${fkCount}ÂÄã„ÅÆÂ§ñÈÉ®„Ç≠„Éº)` : ''}</li>`;
                }).join('')}
              </ul>
            </details>
            
            ${result.referencesToUsers.length > 0 ? `
            <details style="margin-top: 10px;">
              <summary>users„ÉÜ„Éº„Éñ„É´„Å∏„ÅÆÂ§ñÈÉ®„Ç≠„ÉºÂèÇÁÖß</summary>
              <ul style="margin: 5px 0;">
                ${result.referencesToUsers.map(ref => 
                  `<li><strong>${ref.referencingTable}:</strong> ${ref.referencingColumn} ‚Üí users.${ref.referencedColumn}</li>`
                ).join('')}
              </ul>
            </details>
            ` : ''}
            
            ${result.userRelatedData && result.userRelatedData.user ? `
            <details style="margin-top: 10px;">
              <summary>„ÉÜ„Çπ„Éà„É¶„Éº„Ç∂„ÉºÈñ¢ÈÄ£„Éá„Éº„Çø</summary>
              <p><strong>„É¶„Éº„Ç∂„ÉºID:</strong> ${result.userRelatedData.user.id}</p>
              <p><strong>„É°„Éº„É´:</strong> ${result.userRelatedData.user.email}</p>
              <p><strong>„Éã„ÉÉ„ÇØ„Éç„Éº„É†:</strong> ${result.userRelatedData.user.nickname}</p>
              ${Object.keys(result.userRelatedData).filter(key => key !== 'user' && result.userRelatedData[key].length > 0).length > 0 ? `
                <h5>Èñ¢ÈÄ£„Éá„Éº„Çø:</h5>
                <ul>
                  ${Object.keys(result.userRelatedData).filter(key => key !== 'user').map(tableName => {
                    const relatedData = result.userRelatedData[tableName];
                    if (relatedData && relatedData.length > 0) {
                      return `<li><strong>${tableName}:</strong> ${relatedData.map(item => `${item.column}„Å´${item.data.length}‰ª∂`).join(', ')}</li>`;
                    }
                    return '';
                  }).filter(item => item).join('')}
                </ul>
              ` : '<p>Èñ¢ÈÄ£„Éá„Éº„Çø„ÅØË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü</p>'}
            </details>
            ` : '<p>„ÉÜ„Çπ„Éà„É¶„Éº„Ç∂„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü</p>'}
            
            <details style="margin-top: 10px;">
              <summary>ÂÆåÂÖ®„Å™Ë™øÊüªÁµêÊûú</summary>
              <pre style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; overflow-x: auto; font-size: 12px;">${JSON.stringify(result, null, 2)}</pre>
            </details>
          </div>
        `;
        
      } catch (error) {
        addLog('Ë™øÊüª„Ç®„É©„Éº: ' + error.message, 'error');
        const messageArea = document.getElementById('messageArea');
        messageArea.innerHTML = `<div class="error-message">„Éá„Éº„Çø„Éô„Éº„ÇπË™øÊüª„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}</div>`;
      }
    }
    
    // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„ÅÆÂá¶ÁêÜ
    window.addEventListener('load', function() {
      addLog('„É¶„Éº„Ç∂„ÉºÊ§úÁ¥¢„Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü');
    });
  </script>
</body>
</html>
