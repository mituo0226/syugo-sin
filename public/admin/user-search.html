<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢ | AIé‘‘å®šå¸« é¾</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      margin: 0;
      background: #0d0d1a;
      font-family: "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
      color: #fff;
      padding: 20px;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: rgba(13, 13, 26, 0.9);
      border-radius: 20px;
      padding: 40px;
      border: 2px solid rgba(102, 204, 255, 0.4);
    }
    
    .title {
      font-size: 2em;
      color: #66ccff;
      text-align: center;
      margin-bottom: 30px;
    }
    
    .search-section {
      background: rgba(102, 204, 255, 0.1);
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 30px;
      border: 2px solid rgba(102, 204, 255, 0.3);
    }
    
    .search-section h3 {
      color: #66ccff;
      margin-bottom: 15px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: #ccc;
      font-weight: bold;
    }
    
    .form-group input, .form-group select {
      width: 100%;
      padding: 12px;
      border: 1px solid #444;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      font-size: 16px;
      box-sizing: border-box;
    }
    
    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: #66ccff;
      box-shadow: 0 0 10px rgba(102, 204, 255, 0.3);
    }
    
    .form-group select option {
      background: #0d0d1a;
      color: #fff;
    }
    
    .form-group input::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }
    
    .search-button {
      width: 100%;
      padding: 15px;
      font-size: 1.2em;
      background: linear-gradient(90deg, #66ccff, #3399ff);
      border: none;
      border-radius: 15px;
      font-weight: bold;
      cursor: pointer;
      color: #000;
      box-shadow: 0 6px 20px rgba(102,204,255,0.4);
      transition: all 0.3s ease;
      margin-top: 10px;
    }
    
    .search-button:hover {
      background: linear-gradient(90deg, #99e0ff, #66ccff);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102,204,255,0.5);
    }
    
    .search-button:disabled {
      background: #666;
      cursor: not-allowed;
      transform: none;
    }
    
    .result-section {
      background: rgba(13, 13, 26, 0.8);
      padding: 20px;
      border-radius: 10px;
      margin-top: 30px;
      border: 2px solid rgba(102, 204, 255, 0.2);
      display: none;
    }
    
    .result-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: rgba(13, 13, 26, 0.8);
      border-radius: 10px;
      overflow: hidden;
    }
    
    .result-table th, .result-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid rgba(102, 204, 255, 0.2);
    }
    
    .result-table th {
      background: rgba(102, 204, 255, 0.2);
      color: #66ccff;
      font-weight: bold;
    }
    
    .result-table td {
      color: #fff;
    }
    
    .action-buttons {
      margin-top: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .action-button {
      padding: 12px 24px;
      font-size: 1em;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      flex: 1;
      min-width: 120px;
    }
    
    .withdraw-button {
      background: linear-gradient(90deg, #ff6b6b, #ff8e8e);
      color: #fff;
    }
    
    .withdraw-button:hover {
      background: linear-gradient(90deg, #ff5252, #ff6b6b);
      transform: translateY(-2px);
    }
    
    .success-message {
      color: #66ff66;
      margin-top: 20px;
      padding: 15px;
      background: rgba(102, 255, 102, 0.1);
      border-radius: 8px;
      border: 1px solid rgba(102, 255, 102, 0.3);
      text-align: center;
      font-weight: bold;
    }
    
    .error-message {
      color: #ff6b6b;
      margin-top: 20px;
      padding: 15px;
      background: rgba(255, 107, 107, 0.1);
      border-radius: 8px;
      border: 1px solid rgba(255, 107, 107, 0.3);
      text-align: center;
    }
    
    .back-link {
      display: inline-block;
      margin-top: 30px;
      padding: 10px 20px;
      background: rgba(102, 204, 255, 0.2);
      color: #66ccff;
      text-decoration: none;
      border-radius: 8px;
      border: 1px solid rgba(102, 204, 255, 0.4);
      transition: all 0.3s ease;
    }
    
    .back-link:hover {
      background: rgba(102, 204, 255, 0.3);
      transform: translateY(-2px);
    }
    
    .log-area {
      background: rgba(0, 0, 0, 0.5);
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
      font-family: monospace;
      font-size: 14px;
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid rgba(102, 204, 255, 0.2);
    }
    
    .log-entry {
      margin: 5px 0;
      padding: 5px;
      border-radius: 4px;
    }
    
    .log-success {
      background: rgba(102, 255, 102, 0.1);
      color: #66ff66;
    }
    
    .log-error {
      background: rgba(255, 107, 107, 0.1);
      color: #ff6b6b;
    }
    
    .log-info {
      background: rgba(102, 204, 255, 0.1);
      color: #66ccff;
    }
    
    .user-card {
      background: rgba(13, 13, 26, 0.8);
      border: 2px solid rgba(102, 204, 255, 0.3);
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .user-card h4 {
      color: #66ccff;
      margin-top: 0;
      margin-bottom: 15px;
      border-bottom: 1px solid rgba(102, 204, 255, 0.3);
      padding-bottom: 10px;
    }
    
    .user-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .user-info-item {
      background: rgba(102, 204, 255, 0.1);
      padding: 8px 12px;
      border-radius: 5px;
      border: 1px solid rgba(102, 204, 255, 0.2);
    }
    
    .user-info-label {
      font-weight: bold;
      color: #66ccff;
      font-size: 0.9em;
    }
    
    .user-info-value {
      color: #fff;
      margin-top: 2px;
    }
    
    .user-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .user-withdraw-button {
      padding: 8px 16px;
      background: linear-gradient(90deg, #ff6b6b, #ff8e8e);
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9em;
      transition: all 0.3s ease;
    }
    
    .user-withdraw-button:hover {
      background: linear-gradient(90deg, #ff5252, #ff6b6b);
      transform: translateY(-1px);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="title">ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢</h1>
    
    <!-- æ¤œç´¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="search-section">
      <h3>ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢</h3>
      <form id="searchForm">
        <div class="form-group">
          <label for="searchType">æ¤œç´¢ã‚¿ã‚¤ãƒ—</label>
          <select id="searchType" name="searchType" required>
            <option value="">æ¤œç´¢ã‚¿ã‚¤ãƒ—ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="email">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</option>
            <option value="nickname">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </option>
            <option value="birthdate">ç”Ÿå¹´æœˆæ—¥</option>
            <option value="multiple">è¤‡æ•°æ¡ä»¶</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="email">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
          <input type="email" id="email" name="email" placeholder="user@example.com">
        </div>
        
        <div class="form-group">
          <label for="nickname">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </label>
          <input type="text" id="nickname" name="nickname" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ">
        </div>
        
        <div class="form-group">
          <label for="birthdate">ç”Ÿå¹´æœˆæ—¥</label>
          <input type="date" id="birthdate" name="birthdate">
        </div>
        
        <button type="submit" class="search-button" id="searchButton">
          ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¤œç´¢
        </button>
        <button type="button" onclick="debugDatabase()" class="search-button" style="margin-left: 10px; background: linear-gradient(90deg, #6c757d, #495057);">
          ğŸ”§ DBçŠ¶æ…‹ç¢ºèª
        </button>
        <button type="button" onclick="inspectDatabase()" class="search-button" style="margin-left: 10px; background: linear-gradient(90deg, #9d4edd, #7b2cbf);">
          ğŸ” DBè©³ç´°èª¿æŸ»
        </button>
      </form>
    </div>
    
    <!-- çµæœè¡¨ç¤ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div id="resultSection" class="result-section">
      <h3 style="color: #66ccff;">æ¤œç´¢çµæœ</h3>
      <div id="resultCount" style="color: #66ccff; margin-bottom: 15px;"></div>
      <div id="usersContainer">
        <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ãŒã“ã“ã«å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
      </div>
    </div>
    
    <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="messageArea"></div>
    
    <!-- ãƒ­ã‚°è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div class="log-area" id="logArea">
      <div class="log-entry log-info">ãƒ­ã‚°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...</div>
    </div>
    
    <!-- ç®¡ç†ç”»é¢ã«æˆ»ã‚‹ãƒªãƒ³ã‚¯ -->
    <a href="admin.html" class="back-link">â† ç®¡ç†ç”»é¢ã«æˆ»ã‚‹</a>
  </div>

  <script>
    // ãƒ­ã‚°è¡¨ç¤ºé–¢æ•°
    function addLog(message, type = 'info') {
      const logArea = document.getElementById('logArea');
      const logEntry = document.createElement('div');
      logEntry.className = `log-entry log-${type}`;
      logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logArea.appendChild(logEntry);
      logArea.scrollTop = logArea.scrollHeight;
      
      // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚‚å‡ºåŠ›
      if (type === 'error') {
        console.error(message);
      } else if (type === 'success') {
        console.log(message);
      } else {
        console.log(message);
      }
    }
    
    let currentUsers = [];
    
    // æ¤œç´¢ã‚¿ã‚¤ãƒ—å¤‰æ›´æ™‚ã®å‡¦ç†
    document.getElementById('searchType').addEventListener('change', function() {
      const searchType = this.value;
      const emailField = document.getElementById('email');
      const nicknameField = document.getElementById('nickname');
      const birthdateField = document.getElementById('birthdate');
      
      // ã™ã¹ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ
      emailField.value = '';
      nicknameField.value = '';
      birthdateField.value = '';
      
      // æ¤œç´¢ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æœ‰åŠ¹/ç„¡åŠ¹åŒ–
      if (searchType === 'email') {
        emailField.required = true;
        nicknameField.required = false;
        birthdateField.required = false;
      } else if (searchType === 'nickname') {
        emailField.required = false;
        nicknameField.required = true;
        birthdateField.required = false;
      } else if (searchType === 'birthdate') {
        emailField.required = false;
        nicknameField.required = false;
        birthdateField.required = true;
      } else if (searchType === 'multiple') {
        emailField.required = false;
        nicknameField.required = false;
        birthdateField.required = false;
      }
    });
    
    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†
    document.getElementById('searchForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const searchButton = document.getElementById('searchButton');
      const messageArea = document.getElementById('messageArea');
      const resultSection = document.getElementById('resultSection');
      
      // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
      searchButton.disabled = true;
      searchButton.textContent = 'æ¤œç´¢ä¸­...';
      
      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ã¨çµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢
      messageArea.innerHTML = '';
      resultSection.style.display = 'none';
      
      try {
        // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const searchType = document.getElementById('searchType').value;
        const email = document.getElementById('email').value.trim();
        const nickname = document.getElementById('nickname').value.trim();
        const birthdate = document.getElementById('birthdate').value;
        
        // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        if (!searchType) {
          throw new Error('æ¤œç´¢ã‚¿ã‚¤ãƒ—ã‚’é¸æŠã—ã¦ãã ã•ã„');
        }
        
        if (searchType === 'email' && !email) {
          throw new Error('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        }
        if (searchType === 'nickname' && !nickname) {
          throw new Error('ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        }
        if (searchType === 'birthdate' && !birthdate) {
          throw new Error('ç”Ÿå¹´æœˆæ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        }
        if (searchType === 'multiple' && !email && !nickname && !birthdate) {
          throw new Error('å°‘ãªãã¨ã‚‚1ã¤ã®æ¤œç´¢æ¡ä»¶ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        }
        
        addLog(`ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢é–‹å§‹: ã‚¿ã‚¤ãƒ—=${searchType}, email=${email}, nickname=${nickname}, birthdate=${birthdate}`);
        
        // APIã«é€ä¿¡
        const response = await fetch('/api/search-user', {
          method: 'POST',
          mode: 'cors',
          credentials: 'omit',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ 
            email: email,
            nickname: nickname,
            birthdate: birthdate,
            searchType: searchType
          })
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          if (response.status === 404) {
            throw new Error('æ¤œç´¢ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“');
          }
          throw new Error(`æ¤œç´¢ã‚¨ãƒ©ãƒ¼: ${response.status} - ${errorData.error || 'Unknown error'}`);
        }
        
        const result = await response.json();
        currentUsers = result.users;
        
        addLog('ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢å®Œäº†', 'success');
        addLog(`æ¤œç´¢çµæœ: ${result.count}ä»¶ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`);
        
        // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        messageArea.innerHTML = `<div class="success-message">${result.count}ä»¶ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸï¼</div>`;
        
        // æ¤œç´¢çµæœã‚’è¡¨ç¤º
        displayUsers(currentUsers);
        
        // çµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
        resultSection.style.display = 'block';
        
      } catch (error) {
        addLog('æ¤œç´¢ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
        messageArea.innerHTML = `<div class="error-message">æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}</div>`;
      } finally {
        // ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
        searchButton.disabled = false;
        searchButton.textContent = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¤œç´¢';
      }
    });
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
    function displayUsers(users) {
      const resultCount = document.getElementById('resultCount');
      const usersContainer = document.getElementById('usersContainer');
      
      resultCount.textContent = `æ¤œç´¢çµæœ: ${users.length}ä»¶ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`;
      usersContainer.innerHTML = '';
      
      users.forEach((user, index) => {
        const userCard = document.createElement('div');
        userCard.className = 'user-card';
        userCard.innerHTML = `
          <h4>ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${index + 1} (ID: ${user.id})</h4>
          <div class="user-info">
            <div class="user-info-item">
              <div class="user-info-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</div>
              <div class="user-info-value">${user.email}</div>
            </div>
            <div class="user-info-item">
              <div class="user-info-label">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </div>
              <div class="user-info-value">${user.nickname}</div>
            </div>
            <div class="user-info-item">
              <div class="user-info-label">ç”Ÿå¹´æœˆæ—¥</div>
              <div class="user-info-value">${user.birthdate || 'æœªè¨­å®š'}</div>
            </div>
            <div class="user-info-item">
              <div class="user-info-label">å®ˆè­·ç¥ID</div>
              <div class="user-info-value">${user.guardian_id || 'æœªè¨­å®š'}</div>
            </div>
            <div class="user-info-item">
              <div class="user-info-label">ãƒ†ãƒ¼ãƒ</div>
              <div class="user-info-value">${user.theme || 'æœªè¨­å®š'}</div>
            </div>
            <div class="user-info-item">
              <div class="user-info-label">ç™»éŒ²æ—¥æ™‚</div>
              <div class="user-info-value">${user.created_at}</div>
            </div>
          </div>
          <div class="user-actions">
            <button class="user-withdraw-button" onclick="withdrawUser('${user.email}', ${user.id})">
              ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é€€ä¼š
            </button>
          </div>
        `;
        usersContainer.appendChild(userCard);
      });
    }
    
    // å€‹åˆ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é€€ä¼šå‡¦ç†
    async function withdrawUser(email, userId) {
      if (!confirm(`ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ ${email} (ID: ${userId}) ã§é€€ä¼šå‡¦ç†ã‚’è¡Œã„ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
        return;
      }
      
      try {
        addLog(`é€€ä¼šå‡¦ç†é–‹å§‹: ${email} (ID: ${userId})`);
        
        const response = await fetch('/api/withdraw', {
          method: 'POST',
          mode: 'cors',
          credentials: 'omit',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ email: email })
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(`é€€ä¼šã‚¨ãƒ©ãƒ¼: ${response.status} - ${errorData.error || 'Unknown error'}`);
        }
        
        const result = await response.json();
        addLog('é€€ä¼šå‡¦ç†å®Œäº†', 'success');
        addLog(`é€€ä¼šçµæœ: ${JSON.stringify(result, null, 2)}`);
        
        // é€€ä¼šå®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        const messageArea = document.getElementById('messageArea');
        messageArea.innerHTML = `
          <div class="success-message">
            é€€ä¼šå‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸï¼<br>
            ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹: ${result.email}<br>
            ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ : ${result.deleted_user.nickname}<br>
            é€€ä¼šå¾Œã¯åŒã˜ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§å†ç™»éŒ²ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚
          </div>
        `;
        
        // æ¤œç´¢çµæœã‹ã‚‰è©²å½“ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤
        currentUsers = currentUsers.filter(user => user.id !== userId);
        
        if (currentUsers.length === 0) {
          // å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé€€ä¼šã—ãŸå ´åˆ
          document.getElementById('resultSection').style.display = 'none';
          messageArea.innerHTML = `
            <div class="success-message">
              é€€ä¼šå‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸï¼<br>
              ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹: ${result.email}<br>
              ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ : ${result.deleted_user.nickname}<br>
              æ¤œç´¢çµæœã«è©²å½“ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã™ã¹ã¦é€€ä¼šã—ã¾ã—ãŸã€‚
            </div>
          `;
        } else {
          // ã¾ã ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã‚‹å ´åˆã€ä¸€è¦§ã‚’æ›´æ–°
          displayUsers(currentUsers);
          messageArea.innerHTML = `
            <div class="success-message">
              é€€ä¼šå‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸï¼<br>
              ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹: ${result.email}<br>
              ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ : ${result.deleted_user.nickname}<br>
              æ®‹ã‚Šã®ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${currentUsers.length}ä»¶
            </div>
          `;
        }
        
      } catch (error) {
        addLog('é€€ä¼šã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
        const messageArea = document.getElementById('messageArea');
        messageArea.innerHTML = `<div class="error-message">é€€ä¼šå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}</div>`;
      }
    }
    
    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½
    async function debugDatabase() {
      try {
        addLog('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çŠ¶æ…‹ç¢ºèªä¸­...');
        
        const response = await fetch('/api/debug-db', {
          method: 'POST',
          mode: 'cors',
          credentials: 'omit',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({})
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(`ãƒ‡ãƒãƒƒã‚°ã‚¨ãƒ©ãƒ¼: ${response.status} - ${errorData.error || 'Unknown error'}`);
        }
        
        const result = await response.json();
        addLog('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çŠ¶æ…‹ç¢ºèªå®Œäº†', 'success');
        
        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤º
        const messageArea = document.getElementById('messageArea');
        messageArea.innerHTML = `
          <div class="success-message">
            <h4>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çŠ¶æ…‹</h4>
            <p><strong>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ãƒ³ãƒ‰:</strong> ${result.database_bound ? 'OK' : 'NG'}</p>
            <p><strong>ãƒ†ãƒ¼ãƒ–ãƒ«æ•°:</strong> ${result.tables.length}å€‹</p>
            <p><strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°:</strong> ${result.user_count}ä»¶</p>
            <p><strong>ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼:</strong> ${result.test_user ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}</p>
            <p><strong>å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„:</strong> ${result.foreign_keys_enabled ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'}</p>
            ${result.all_foreign_keys.length > 0 ? `<p><strong>å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„:</strong> ${result.all_foreign_keys.length}å€‹ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã§åˆ¶ç´„ã‚ã‚Š</p>` : ''}
            <details style="margin-top: 10px;">
              <summary>ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§</summary>
              <ul style="margin: 5px 0;">
                ${result.tables.map(table => `<li>${table.name}</li>`).join('')}
              </ul>
            </details>
            ${result.all_foreign_keys.length > 0 ? `
            <details style="margin-top: 10px;">
              <summary>å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„</summary>
              <ul style="margin: 5px 0;">
                ${result.all_foreign_keys.map(fk => 
                  `<li><strong>${fk.table}:</strong> ${fk.foreign_keys.map(key => 
                    `${key.from} â†’ ${key.table}.${key.to}`
                  ).join(', ')}</li>`
                ).join('')}
              </ul>
            </details>
            ` : ''}
            <details style="margin-top: 10px;">
              <summary>è©³ç´°æƒ…å ±</summary>
              <pre style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; overflow-x: auto; font-size: 12px;">${JSON.stringify(result, null, 2)}</pre>
            </details>
          </div>
        `;
        
      } catch (error) {
        addLog('ãƒ‡ãƒãƒƒã‚°ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
        const messageArea = document.getElementById('messageArea');
        messageArea.innerHTML = `<div class="error-message">ãƒ‡ãƒãƒƒã‚°å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}</div>`;
      }
    }
    
    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è©³ç´°èª¿æŸ»æ©Ÿèƒ½
    async function inspectDatabase() {
      try {
        addLog('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è©³ç´°èª¿æŸ»ä¸­...');
        
        const response = await fetch('/api/inspect-db', {
          method: 'POST',
          mode: 'cors',
          credentials: 'omit',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({})
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(`èª¿æŸ»ã‚¨ãƒ©ãƒ¼: ${response.status} - ${errorData.error || 'Unknown error'}`);
        }
        
        const result = await response.json();
        addLog('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è©³ç´°èª¿æŸ»å®Œäº†', 'success');
        
        // èª¿æŸ»çµæœã‚’è¡¨ç¤º
        const messageArea = document.getElementById('messageArea');
        messageArea.innerHTML = `
          <div class="success-message">
            <h4>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è©³ç´°èª¿æŸ»çµæœ</h4>
            <p><strong>ãƒ†ãƒ¼ãƒ–ãƒ«æ•°:</strong> ${result.tables.length}å€‹</p>
            <p><strong>å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„:</strong> ${result.foreignKeysEnabled ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'}</p>
            <p><strong>usersãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®å‚ç…§:</strong> ${result.referencesToUsers.length}å€‹</p>
            
            <details style="margin-top: 10px;">
              <summary>ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã¨ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°</summary>
              <ul style="margin: 5px 0;">
                ${Object.keys(result.tableSchemas).map(tableName => {
                  const schema = result.tableSchemas[tableName];
                  const count = schema.recordCount !== undefined ? schema.recordCount : '?';
                  const fkCount = schema.foreignKeys ? schema.foreignKeys.length : 0;
                  return `<li><strong>${tableName}:</strong> ${count}ä»¶ ${fkCount > 0 ? `(${fkCount}å€‹ã®å¤–éƒ¨ã‚­ãƒ¼)` : ''}</li>`;
                }).join('')}
              </ul>
            </details>
            
            ${result.referencesToUsers.length > 0 ? `
            <details style="margin-top: 10px;">
              <summary>usersãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®å¤–éƒ¨ã‚­ãƒ¼å‚ç…§</summary>
              <ul style="margin: 5px 0;">
                ${result.referencesToUsers.map(ref => 
                  `<li><strong>${ref.referencingTable}:</strong> ${ref.referencingColumn} â†’ users.${ref.referencedColumn}</li>`
                ).join('')}
              </ul>
            </details>
            ` : ''}
            
            ${result.userRelatedData && result.userRelatedData.user ? `
            <details style="margin-top: 10px;">
              <summary>ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼é–¢é€£ãƒ‡ãƒ¼ã‚¿</summary>
              <p><strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼ID:</strong> ${result.userRelatedData.user.id}</p>
              <p><strong>ãƒ¡ãƒ¼ãƒ«:</strong> ${result.userRelatedData.user.email}</p>
              <p><strong>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ :</strong> ${result.userRelatedData.user.nickname}</p>
              ${Object.keys(result.userRelatedData).filter(key => key !== 'user' && result.userRelatedData[key].length > 0).length > 0 ? `
                <h5>é–¢é€£ãƒ‡ãƒ¼ã‚¿:</h5>
                <ul>
                  ${Object.keys(result.userRelatedData).filter(key => key !== 'user').map(tableName => {
                    const relatedData = result.userRelatedData[tableName];
                    if (relatedData && relatedData.length > 0) {
                      return `<li><strong>${tableName}:</strong> ${relatedData.map(item => `${item.column}ã«${item.data.length}ä»¶`).join(', ')}</li>`;
                    }
                    return '';
                  }).filter(item => item).join('')}
                </ul>
              ` : '<p>é–¢é€£ãƒ‡ãƒ¼ã‚¿ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>'}
            </details>
            ` : '<p>ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>'}
            
            <details style="margin-top: 10px;">
              <summary>å®Œå…¨ãªèª¿æŸ»çµæœ</summary>
              <pre style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; overflow-x: auto; font-size: 12px;">${JSON.stringify(result, null, 2)}</pre>
            </details>
          </div>
        `;
        
      } catch (error) {
        addLog('èª¿æŸ»ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
        const messageArea = document.getElementById('messageArea');
        messageArea.innerHTML = `<div class="error-message">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹èª¿æŸ»ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}</div>`;
      }
    }
    
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
    window.addEventListener('load', function() {
      addLog('ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
    });
  </script>
</body>
</html>
