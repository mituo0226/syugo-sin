<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="format-detection" content="telephone=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>守護神導出 - 守護神占い</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
      background: #000;
      color: #fff;
      overflow: hidden;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      /* iOS Safari対応 */
      -webkit-overflow-scrolling: touch;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }

    .guardian-animation-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    .guardian-video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 1;
      /* iOS Safari対応 */
      -webkit-playsinline: true;
      playsinline: true;
    }

    .guardian-fallback-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 1;
      display: none;
    }

    .loading-indicator {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 5;
      text-align: center;
      color: #FFD700;
      font-size: 18px;
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
    }

    .loading-indicator.show {
      opacity: 1;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255, 215, 0, 0.3);
      border-top: 3px solid #FFD700;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 16px;
      color: #FFD700;
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.7; }
      50% { opacity: 1; }
    }

    .loading-progress {
      width: 200px;
      height: 4px;
      background: rgba(255, 215, 0, 0.2);
      border-radius: 2px;
      margin: 10px auto;
      overflow: hidden;
    }

    .loading-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #FFD700, #FFA500);
      width: 0%;
      transition: width 0.3s ease;
      border-radius: 2px;
    }

    .guardian-text-overlay {
      position: relative;
      z-index: 10;
      text-align: center;
      color: #fff;
      max-width: 800px;
      padding: 20px;
    }

    .guardian-text {
      font-size: clamp(24px, 5vw, 36px);
      font-weight: bold;
      margin-bottom: 20px;
      text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
      opacity: 0;
      animation: fadeInText 1s ease-in-out 2s forwards;
    }

    .guardian-subtitle {
      font-size: clamp(18px, 3vw, 24px);
      color: #FFD700;
      text-shadow: 0 0 15px rgba(255, 215, 0, 0.6);
      opacity: 0;
      animation: fadeInText 1s ease-in-out 3s forwards;
    }

    @keyframes fadeInText {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .fade-out {
      animation: fadeOut 1s ease-in-out forwards;
    }

    @keyframes fadeOut {
      from {
        opacity: 1;
      }
      to {
        opacity: 0;
      }
    }

    /* スマートフォン対応 */
    @media screen and (max-width: 768px) {
      .loading-text {
        font-size: 14px;
      }
      
      .loading-progress {
        width: 150px;
      }
    }
  </style>
</head>
<body>
  <div class="guardian-animation-container">
    <video id="guardianVideo" class="guardian-video" muted preload="auto" playsinline webkit-playsinline>
      <source src="../photo/god.mp4" type="video/mp4">
    </video>
    <img id="guardianFallbackImage" class="guardian-fallback-image" src="../photo/ryu.png" alt="守護神導出">
    
    <!-- ローディング表示 -->
    <div id="loadingIndicator" class="loading-indicator">
      <div class="loading-spinner"></div>
      <div class="loading-text">守護神の力を呼び出しています...</div>
      <div class="loading-progress">
        <div id="loadingProgressBar" class="loading-progress-bar"></div>
      </div>
    </div>
    
    <div class="guardian-text-overlay">
      <div class="guardian-text">守護神が導き出される</div>
      <div class="guardian-subtitle">運命の扉が開かれる...</div>
    </div>
  </div>

  <script>
    // URLパラメータから生年月日を取得
    function getBirthDateFromURL() {
      const urlParams = new URLSearchParams(window.location.search);
      return {
        year: urlParams.get('year'),
        month: urlParams.get('month'),
        day: urlParams.get('day')
      };
    }

    // kekka.htmlに遷移
    function redirectToKekka() {
      const birthDate = getBirthDateFromURL();
      if (birthDate.year && birthDate.month && birthDate.day) {
        const params = new URLSearchParams(birthDate);
        window.location.href = `../ritual/kekka.html?${params.toString()}`;
      } else {
        // パラメータがない場合はb-form.htmlに戻る
        window.location.href = 'b-form.html';
      }
    }

    // iPhone/iOS検出
    function isIOS() {
      return /iPad|iPhone|iPod/.test(navigator.userAgent) || 
             (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
    }

    // 守護神導出アニメーション処理
    function startGuardianAnimation() {
      const guardianVideo = document.getElementById('guardianVideo');
      const loadingIndicator = document.getElementById('loadingIndicator');
      const progressBar = document.getElementById('loadingProgressBar');
      let hasStartedPlaying = false; // 動画再生開始フラグ
      let loadTimeout; // タイムアウト用変数
      
      if (!guardianVideo || !loadingIndicator) {
        console.error('Required elements not found');
        redirectToKekka();
        return;
      }

      console.log('=== 守護神導出アニメーション開始 ===');
      console.log('動画パス:', guardianVideo.querySelector('source').src);
      console.log('iOS環境:', isIOS());
      
      // ローディング表示を開始
      loadingIndicator.classList.add('show');
      console.log('ローディング表示開始');

      // iOS用の設定
      if (isIOS()) {
        guardianVideo.playsInline = true;
        guardianVideo.setAttribute('playsinline', '');
        guardianVideo.setAttribute('webkit-playsinline', '');
      }
      
      // 動画の読み込み状態を監視
      guardianVideo.addEventListener('loadstart', () => {
        console.log('動画読み込み開始');
        if (progressBar) {
          progressBar.style.width = '10%';
        }
      });

      guardianVideo.addEventListener('progress', () => {
        if (guardianVideo.buffered.length > 0) {
          const bufferedEnd = guardianVideo.buffered.end(guardianVideo.buffered.length - 1);
          const duration = guardianVideo.duration;
          if (duration > 0) {
            const progress = (bufferedEnd / duration) * 100;
            if (progressBar) {
              progressBar.style.width = Math.min(progress, 90) + '%';
            }
            console.log('読み込み進捗:', Math.round(progress) + '%');
          }
        }
      });

      guardianVideo.addEventListener('loadeddata', () => {
        console.log('動画データ読み込み完了');
        if (progressBar) {
          progressBar.style.width = '95%';
        }
      });

      guardianVideo.addEventListener('canplay', () => {
        console.log('動画再生可能');
        // ローディング表示を非表示
        loadingIndicator.classList.remove('show');
        console.log('ローディング表示終了');
      });

      guardianVideo.addEventListener('playing', () => {
        console.log('動画再生中');
        // プログレスバーを100%にしてから非表示
        if (progressBar) {
          progressBar.style.width = '100%';
        }
        // ローディング表示を非表示
        loadingIndicator.classList.remove('show');
        console.log('ローディング表示終了');
      });
      
      // 動画の再生完了を監視（iOS対応強化）
      let videoEnded = false;
      
      guardianVideo.addEventListener('ended', () => {
        if (videoEnded) return;
        videoEnded = true;
        console.log('Guardian video ended, transitioning to kekka.html');
        
        // フェードアウト
        document.querySelector('.guardian-animation-container').classList.add('fade-out');
        
        // iOSでは遷移を少し遅らせる
        const delay = isIOS() ? 1500 : 1000;
        setTimeout(() => {
          redirectToKekka();
        }, delay);
      });

      // iOS用: 動画の時間進行を監視してより確実な遷移
      if (isIOS()) {
        guardianVideo.addEventListener('timeupdate', () => {
          if (guardianVideo.duration && guardianVideo.currentTime >= guardianVideo.duration - 0.5) {
            // 動画終了の0.5秒前にも遷移準備
            if (!videoEnded) {
              videoEnded = true;
              console.log('IOS: Video near end, preparing transition');
            }
          }
        });
      }

      // 動画のエラーハンドリング
      guardianVideo.addEventListener('error', (e) => {
        console.error('Video error:', e);
        console.error('動画エラー詳細:', guardianVideo.error);
        
        // ローディング表示を非表示
        loadingIndicator.classList.remove('show');
        
        // フォールバック画像を表示
        const fallbackImage = document.getElementById('guardianFallbackImage');
        if (fallbackImage) {
          guardianVideo.style.display = 'none';
          fallbackImage.style.display = 'block';
          console.log('フォールバック画像を表示');
        }
        
        // 3秒後に遷移
        setTimeout(() => {
          redirectToKekka();
        }, 3000);
      });

      // 動画の読み込み完了を待ってから再生（iOS対応強化）
      const playVideo = () => {
        console.log('動画再生を開始します...');
        
        // 読み込み状態をチェック
        console.log('動画読み込み状態:', guardianVideo.readyState);
        console.log('動画継続時間:', guardianVideo.duration);
        
        // iOSではより確実な再生のため、少し長めの遅延
        if (isIOS()) {
          setTimeout(() => {
            startVideoPlayback();
          }, 500);
        } else {
          setTimeout(() => {
            startVideoPlayback();
          }, 100);
        }
      };

      const startVideoPlayback = () => {
        console.log('動画再生実行中...');
        const playPromise = guardianVideo.play();
        
        if (playPromise !== undefined) {
          playPromise.then(() => {
            console.log('動画再生成功');
            hasStartedPlaying = true;
            // ローディング表示を非表示
            loadingIndicator.classList.remove('show');
          }).catch(error => {
            console.error('Video play failed:', error);
            console.log('再生失敗、フォールバック画像を表示');
            
            // フォールバック画像を表示
            const fallbackImage = document.getElementById('guardianFallbackImage');
            if (fallbackImage) {
              guardianVideo.style.display = 'none';
              fallbackImage.style.display = 'block';
              loadingIndicator.classList.remove('show');
            }
            
            // 3秒後に遷移
            setTimeout(() => {
              redirectToKekka();
            }, 3000);
          });
        } else {
          console.log('動画再生Promise未対応ブラウザ');
          hasStartedPlaying = true;
        }
      };

      // 動画読み込み状態をチェックして再生開始
      const checkAndPlayVideo = () => {
        if (guardianVideo.readyState >= 2) { // HAVE_CURRENT_DATA以上
          console.log('動画データ読み込み完了、再生開始');
          playVideo();
        } else {
          console.log('動画読み込み待機中...');
        }
      };

      // 複数のイベントで再生を試行
      guardianVideo.addEventListener('loadstart', () => {
        console.log('動画読み込み開始検知');
      });

      guardianVideo.addEventListener('loadeddata', () => {
        console.log('動画データ読み込み完了検知');
        checkAndPlayVideo();
      });

      guardianVideo.addEventListener('canplay', () => {
        console.log('動画再生可能検知');
        checkAndPlayVideo();
        // タイムアウトクリア
        if (loadTimeout) {
          clearTimeout(loadTimeout);
          console.log('タイムアウトクリア（canplay）');
        }
      });

      guardianVideo.addEventListener('canplaythrough', () => {
        console.log('動画完全読み込み検知');
        checkAndPlayVideo();
        // タイムアウトクリア
        if (loadTimeout) {
          clearTimeout(loadTimeout);
          console.log('タイムアウトクリア（canplaythrough）');
        }
      });

      guardianVideo.addEventListener('playing', () => {
        hasStartedPlaying = true;
        console.log('動画再生開始検知、タイムアウトクリア');
        if (loadTimeout) {
          clearTimeout(loadTimeout);
        }
      });

      // 初期チェック
      setTimeout(checkAndPlayVideo, 1000);

      // 動画読み込みタイムアウト処理（iOS対応強化）
      
      // より長いタイムアウト時間を設定（動画再生開始まで）
      const timeoutDuration = isIOS() ? 15000 : 8000;
      
      loadTimeout = setTimeout(() => {
        // 動画再生が開始されていない場合のみフォールバック実行
        if (!hasStartedPlaying) {
          console.log('動画読み込みタイムアウト（再生未開始）、フォールバック画像を表示');
          
          // ローディング表示を非表示
          loadingIndicator.classList.remove('show');
          
          const fallbackImage = document.getElementById('guardianFallbackImage');
          if (fallbackImage) {
            guardianVideo.style.display = 'none';
            fallbackImage.style.display = 'block';
          }
        }
      }, timeoutDuration);

      // フォールバック: iOSでは少し長めに設定
      const fallbackDuration = isIOS() ? 15000 : 10000;
      setTimeout(() => {
        console.log('フォールバック: ' + (fallbackDuration/1000) + '秒経過、強制遷移');
        if (!videoEnded) {
          redirectToKekka();
        }
      }, fallbackDuration);
    }

    // ページ読み込み時にアニメーション開始
    document.addEventListener('DOMContentLoaded', startGuardianAnimation);
    
    // 既にDOMが読み込まれている場合の対応
    if (document.readyState !== 'loading') {
      startGuardianAnimation();
    }
  </script>
</body>
</html>
