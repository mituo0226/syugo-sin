<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="format-detection" content="telephone=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>守護神導出 - 守護神占い</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
      background: #000;
      color: #fff;
      overflow: hidden;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      /* iOS Safari対応 */
      -webkit-overflow-scrolling: touch;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }

    .guardian-animation-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    .guardian-video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 1;
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
    }

    .guardian-video.active {
      opacity: 1;
    }

    .guardian-video.overlapping {
      opacity: 0.8;
    }

    .guardian-fallback-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 1;
      display: none;
    }

    .loading-indicator {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 5;
      text-align: center;
      color: #FFD700;
      font-size: 18px;
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
    }

    .loading-indicator.show {
      opacity: 1;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255, 215, 0, 0.3);
      border-top: 3px solid #FFD700;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 16px;
      color: #FFD700;
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.7; }
      50% { opacity: 1; }
    }


    .guardian-text-overlay {
      position: relative;
      z-index: 10;
      text-align: center;
      color: #fff;
      max-width: 800px;
      padding: 20px;
    }

    .guardian-text {
      font-size: clamp(24px, 5vw, 36px);
      font-weight: bold;
      margin-bottom: 20px;
      text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
      opacity: 0;
      animation: fadeInText 1s ease-in-out 2s forwards;
    }

    .guardian-subtitle {
      font-size: clamp(18px, 3vw, 24px);
      color: #FFD700;
      text-shadow: 0 0 15px rgba(255, 215, 0, 0.6);
      opacity: 0;
      animation: fadeInText 1s ease-in-out 3s forwards;
    }

    @keyframes fadeInText {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .fade-out {
      animation: fadeOut 1s ease-in-out forwards;
    }

    @keyframes fadeOut {
      from {
        opacity: 1;
      }
      to {
        opacity: 0;
      }
    }

    /* スマートフォン対応 */
    @media screen and (max-width: 768px) {
      .loading-text {
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <div class="guardian-animation-container">
    <!-- 5つの動画シーケンス -->
    <video id="guardianVideo1" class="guardian-video" muted preload="auto" playsinline webkit-playsinline>
      <source src="../photo/god1.mp4" type="video/mp4">
    </video>
    <video id="guardianVideo2" class="guardian-video" muted preload="auto" playsinline webkit-playsinline>
      <source src="../photo/god2.mp4" type="video/mp4">
    </video>
    <video id="guardianVideo3" class="guardian-video" muted preload="auto" playsinline webkit-playsinline>
      <source src="../photo/god3.mp4" type="video/mp4">
    </video>
    <video id="guardianVideo4" class="guardian-video" muted preload="auto" playsinline webkit-playsinline>
      <source src="../photo/god4.mp4" type="video/mp4">
    </video>
    <video id="guardianVideo5" class="guardian-video" muted preload="auto" playsinline webkit-playsinline>
      <source src="../photo/god5.mp4" type="video/mp4">
    </video>
    
    <img id="guardianFallbackImage" class="guardian-fallback-image" src="../photo/ryu.png" alt="守護神導出">
    
    <!-- ローディング表示 -->
    <div id="loadingIndicator" class="loading-indicator">
      <div class="loading-spinner"></div>
      <div class="loading-text">守護神の力を呼び出しています...</div>
    </div>
    
    <div class="guardian-text-overlay">
      <div class="guardian-text">守護神が導き出される</div>
      <div class="guardian-subtitle">運命の扉が開かれる...</div>
    </div>
  </div>

  <script>
    // URLパラメータから生年月日を取得
    function getBirthDateFromURL() {
      const urlParams = new URLSearchParams(window.location.search);
      return {
        year: urlParams.get('year'),
        month: urlParams.get('month'),
        day: urlParams.get('day')
      };
    }

    // kekka.htmlに遷移
    function redirectToKekka() {
      const birthDate = getBirthDateFromURL();
      if (birthDate.year && birthDate.month && birthDate.day) {
        const params = new URLSearchParams(birthDate);
        window.location.href = `../ritual/kekka.html?${params.toString()}`;
      } else {
        // パラメータがない場合はb-form.htmlに戻る
        window.location.href = 'b-form.html';
      }
    }


    // 5つの動画シーケンス処理
    function startGuardianAnimation() {
      console.log('=== 守護神導出動画シーケンス開始 ===');
      
      const loadingIndicator = document.getElementById('loadingIndicator');
      
      if (!loadingIndicator) {
        console.error('Required elements not found');
        redirectToKekka();
        return;
      }

      // ローディング表示を開始
      loadingIndicator.classList.add('show');
      console.log('ローディング表示開始');

      // 5つの動画を取得
      const videos = [];
      for (let i = 1; i <= 5; i++) {
        const video = document.getElementById(`guardianVideo${i}`);
        if (video) {
          videos.push(video);
        }
      }

      if (videos.length === 0) {
        console.error('No videos found');
        redirectToKekka();
        return;
      }

      let currentVideoIndex = 0;
      let currentVideo = null;
      let nextVideo = null;
      let eventListeners = new Map(); // イベントリスナーを管理

      const cleanupListeners = (video) => {
        if (eventListeners.has(video)) {
          const listeners = eventListeners.get(video);
          listeners.ended && video.removeEventListener('ended', listeners.ended);
          listeners.error && video.removeEventListener('error', listeners.error);
          listeners.timeupdate && video.removeEventListener('timeupdate', listeners.timeupdate);
          listeners.timeout && clearTimeout(listeners.timeout);
          eventListeners.delete(video);
        }
      };

      const startVideoSequence = () => {
        if (currentVideoIndex >= videos.length) {
          // 全ての動画が終了したらkekka.htmlに遷移
          console.log('All videos completed, transitioning to kekka.html');
          document.querySelector('.guardian-animation-container').classList.add('fade-out');
          setTimeout(() => {
            redirectToKekka();
          }, 1000);
          return;
        }

        currentVideo = videos[currentVideoIndex];
        
        // 次の動画を準備（最後の動画でない場合）
        if (currentVideoIndex + 1 < videos.length) {
          nextVideo = videos[currentVideoIndex + 1];
          nextVideo.currentTime = 0;
        }

        console.log(`Starting video ${currentVideoIndex + 1}/5`);

        // 現在の動画を表示・再生
        currentVideo.classList.add('active');
        
        // 動画の長さを取得して重なり合いタイミングを計算
        const setupOverlapTransition = () => {
          if (!currentVideo.duration || !nextVideo) return;

          const duration = currentVideo.duration;
          const overlapDuration = 1.0; // 重なり合い時間（秒）
          const transitionStartTime = duration - overlapDuration;
          
          console.log(`Video ${currentVideoIndex + 1} duration: ${duration}s, transition starts at: ${transitionStartTime}s`);

          // 動画が終了間近になったら次の動画を開始
          const onTimeUpdate = () => {
            if (currentVideo.currentTime >= transitionStartTime && nextVideo) {
              console.log(`Starting overlap transition from video ${currentVideoIndex + 1} to ${currentVideoIndex + 2}`);
              
              // 次の動画を重なり合い状態で開始
              nextVideo.classList.add('active', 'overlapping');
              nextVideo.play().catch(error => {
                console.error(`Next video ${currentVideoIndex + 2} play failed:`, error);
              });
              
              // 時間更新イベントを削除（一度だけ実行）
              currentVideo.removeEventListener('timeupdate', onTimeUpdate);
            }
          };

          currentVideo.addEventListener('timeupdate', onTimeUpdate);
          
          // 既存のリスナーを更新
          const existingListeners = eventListeners.get(currentVideo) || {};
          existingListeners.timeupdate = onTimeUpdate;
          eventListeners.set(currentVideo, existingListeners);
        };

        // 動画エラーハンドリング
        const onVideoError = () => {
          console.error(`Video ${currentVideoIndex + 1} error, skipping to next`);
          cleanupListeners(currentVideo);
          currentVideoIndex++;
          setTimeout(startVideoSequence, 1000);
        };

        // 動画終了を監視
        const onVideoEnded = () => {
          console.log(`Video ${currentVideoIndex + 1} ended`);
          cleanupListeners(currentVideo);
          
          // 現在の動画を非表示にする
          currentVideo.classList.remove('active', 'overlapping');
          
          // 次の動画があれば重なり合い状態を解除して完全表示
          if (nextVideo && currentVideoIndex + 1 < videos.length) {
            nextVideo.classList.remove('overlapping');
            currentVideoIndex++;
            setTimeout(startVideoSequence, 200); // 短い間隔で次の動画へ
          } else {
            // 最後の動画の場合は遷移
            currentVideoIndex++;
            setTimeout(startVideoSequence, 500);
          }
        };

        // イベントリスナーを設定
        currentVideo.addEventListener('error', onVideoError);
        currentVideo.addEventListener('ended', onVideoEnded);
        
        const timeoutId = setTimeout(() => {
          console.log(`Video ${currentVideoIndex + 1} timeout, moving to next`);
          onVideoEnded();
        }, 10000);
        
        eventListeners.set(currentVideo, { 
          ended: onVideoEnded, 
          error: onVideoError,
          timeout: timeoutId
        });

        // 動画を再生
        const playPromise = currentVideo.play();
        if (playPromise !== undefined) {
          playPromise.then(() => {
            console.log(`Video ${currentVideoIndex + 1} started playing`);
            // ローディング表示を非表示
            if (currentVideoIndex === 0) {
              loadingIndicator.classList.remove('show');
            }
            // 動画が開始されたら重なり合いタイミングを設定
            setTimeout(setupOverlapTransition, 100);
          }).catch(error => {
            console.error(`Video ${currentVideoIndex + 1} play failed:`, error);
            onVideoError();
          });
        }
      };

      // 最初の動画再生を開始
      setTimeout(() => {
        startVideoSequence();
      }, 500);
    }

    // ページ読み込み時にアニメーション開始
    document.addEventListener('DOMContentLoaded', startGuardianAnimation);
    
    // 既にDOMが読み込まれている場合の対応
    if (document.readyState !== 'loading') {
      startGuardianAnimation();
    }
  </script>
</body>
</html>
