<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>神の世界への導き | AI鑑定師 龍</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover, maximum-scale=1.0, minimum-scale=1.0">
  <meta name="format-detection" content="telephone=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: #000;
      font-family: "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
      color: #fff;
      overflow: hidden;
      position: relative;
      min-height: 100vh;
      -webkit-text-size-adjust: 100%;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      /* iOS Safari対応 */
      -webkit-overflow-scrolling: touch;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }
    
    /* ローディング画面 */
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
    }

    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid #FFD700;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      position: absolute;
      bottom: 30%;
      left: 50%;
      transform: translateX(-50%);
      color: #FFD700;
      font-size: 18px;
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.7; }
      50% { opacity: 1; }
    }
    
    /* 動画コンテナ */
    .video-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
    }
    
    .god-video {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: 1;
      opacity: 0;
      transition: opacity 1.5s ease-in-out;
    }
    
    .god-video.show {
      opacity: 1;
    }
    
    .god-video.fade-in {
      animation: smoothFadeIn 1s ease-in-out forwards;
    }
    
    .god-video.fade-out {
      animation: smoothFadeOut 1s ease-in-out forwards;
    }
    
    @keyframes smoothFadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes smoothFadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
    
    
    /* 最終画像（4.png） */
    .final-image {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: 1;
      opacity: 0;
      transition: opacity 3s ease-in-out;
    }
    
    .final-image.show {
      opacity: 1;
    }
    
    /* スマートフォン対応 */
    @media screen and (max-width: 768px) {
      .loading-spinner {
        width: 50px;
        height: 50px;
        border-width: 3px;
      }
      
      .loading-text {
        font-size: 16px;
        bottom: 25%;
      }
    }
  </style>
</head>
<body>
  <!-- ローディング画面 -->
  <div id="loadingScreen" class="loading-screen">
    <div class="loading-spinner"></div>
    <div class="loading-text">神の世界へ導いています...</div>
  </div>
  
  <!-- 動画コンテナ -->
  <div class="video-container">
    <!-- 1.mp4動画 -->
    <video class="god-video" id="video1" muted preload="auto" playsinline webkit-playsinline onerror="handleVideoError(this, 'video1')" onloadstart="console.log('video1 読み込み開始')" oncanplay="console.log('video1 再生可能')">
      <source src="../photo/god2/1.mp4" type="video/mp4">
    </video>
    
    <!-- 2.mp4動画 -->
    <video class="god-video" id="video2" muted preload="metadata" playsinline webkit-playsinline onerror="handleVideoError(this, 'video2')" onloadstart="console.log('video2 読み込み開始')" oncanplay="console.log('video2 再生可能')">
      <source src="../photo/god2/2.mp4" type="video/mp4">
    </video>
    
    <!-- 3.mp4動画 -->
    <video class="god-video" id="video3" muted preload="auto" playsinline webkit-playsinline onerror="handleVideoError(this, 'video3')" onloadstart="console.log('video3 読み込み開始')" oncanplay="console.log('video3 再生可能')" onloadeddata="console.log('video3 データ読み込み完了')" oncanplaythrough="console.log('video3 完全再生可能')">
      <source src="../photo/god2/3.mp4" type="video/mp4">
    </video>
  </div>
  
  <!-- 最終画像（4.png） -->
  <img class="final-image" id="finalImage" src="../photo/god2/4.png" alt="最終画像" onload="console.log('最終画像 読み込み完了')" onerror="console.error('最終画像 読み込みエラー')">

  <script>
    // ローカルストレージの確認と引き継ぎ
    function ensureLocalStorageData() {
      console.log("=== ローカルストレージデータの確認と引き継ぎ ===");
      
      // 現在のURLパラメータを取得
      const urlParams = new URLSearchParams(window.location.search);
      console.log("URLパラメータ:", urlParams.toString());
      
      // localStorageから既存データを取得
      const existingData = localStorage.getItem("userData");
      let userData = {};
      
      if (existingData) {
        try {
          userData = JSON.parse(existingData);
          console.log("既存のlocalStorageデータ:", userData);
        } catch (error) {
          console.error("localStorageデータのパースエラー:", error);
          userData = {};
        }
      }
      
      // URLパラメータからデータを取得
      const urlData = {
        nickname: urlParams.get('nickname'),
        birthYear: urlParams.get('birthYear'),
        birthMonth: urlParams.get('birthMonth'),
        birthDay: urlParams.get('birthDay'),
        guardianKey: urlParams.get('guardianKey'),
        worry: urlParams.get('worry')
      };
      
      console.log("URLパラメータデータ:", urlData);
      
      // データの統合（URLパラメータを優先）
      const finalData = { ...userData, ...urlData };
      
      // 空の値を削除
      Object.keys(finalData).forEach(key => {
        if (!finalData[key]) {
          delete finalData[key];
        }
      });
      
      console.log("統合後のデータ:", finalData);
      
      // localStorageに保存
      if (Object.keys(finalData).length > 0) {
        localStorage.setItem("userData", JSON.stringify(finalData));
        console.log("localStorageにデータを保存しました");
      }
      
      return finalData;
    }
    
    // 動画エラーハンドリング
    function handleVideoError(videoElement, videoId) {
      console.error(`動画エラー: ${videoId}`, videoElement.error);
      
      // エラー時の処理
      setTimeout(() => {
        proceedToCosmos();
      }, 2000);
    }
    
    // ritual-cosmos.htmlに遷移
    function proceedToCosmos() {
      console.log('ritual-cosmos.htmlに遷移します');
      
      // 現在のURLパラメータを保持して遷移
      const currentParams = window.location.search;
      window.location.href = `ritual-cosmos.html${currentParams}`;
    }
    
    // 動画準備完了チェック
    let videoReadyCount = 0;
    const totalVideos = 3; // video1, video2, video3
    let loadingScreenShown = false;
    
    function showLoadingScreen() {
      if (!loadingScreenShown) {
        const loadingScreen = document.getElementById('loadingScreen');
        loadingScreen.style.display = 'flex';
        loadingScreen.style.opacity = '1';
        loadingScreenShown = true;
        console.log('ローディング画面を表示');
      }
    }
    
    function checkVideoReady() {
      videoReadyCount++;
      console.log(`動画準備完了: ${videoReadyCount}/${totalVideos}`);
      
      if (videoReadyCount >= totalVideos) {
        console.log('すべての動画の準備が完了しました');
        startVideoSequenceAfterReady();
      }
    }
    
    function startVideoSequenceAfterReady() {
      // ローディング画面を非表示
      hideLoadingScreen();
      
      // 動画シーケンス開始
      setTimeout(() => {
        startVideoSequence();
      }, 500);
    }
    
    function setupVideoReadyListeners() {
      const videoIds = ['video1', 'video2', 'video3'];
      let hasLoadingStarted = false;
      
      videoIds.forEach(videoId => {
        const video = document.getElementById(videoId);
        if (video) {
          // 既に準備完了している場合
          if (video.readyState >= 1) {
            console.log(`${videoId} は既に準備完了しています`);
            checkVideoReady();
          } else {
            // 読み込み待機中にローディング画面を表示
            if (!hasLoadingStarted) {
              showLoadingScreen();
              hasLoadingStarted = true;
            }
            
            // 複数のイベントを監視（Android対応）
            const checkVideoReadyOnce = () => {
              console.log(`${videoId} の準備が完了しました`);
              checkVideoReady();
            };
            
            // canplayイベントを待つ
            video.addEventListener('canplay', checkVideoReadyOnce, { once: true });
            
            // Android対応: loadeddataイベントも監視
            video.addEventListener('loadeddata', checkVideoReadyOnce, { once: true });
            
            // Android対応: canplaythroughイベントも監視
            video.addEventListener('canplaythrough', checkVideoReadyOnce, { once: true });
            
            // エラー時の処理
            video.addEventListener('error', (e) => {
              console.error(`${videoId} でエラーが発生しました:`, e);
              checkVideoReady(); // エラーでもカウントを進める
            }, { once: true });
          }
        } else {
          console.error(`${videoId} が見つかりません`);
          checkVideoReady(); // 見つからない場合もカウントを進める
        }
      });
    }
    
    // ページ読み込み時の処理
    window.addEventListener("load", function() {
      try {
        console.log("=== ritual-animation.html ページ読み込み開始 ===");
        
        // ローカルストレージデータの確認と引き継ぎ
        const userData = ensureLocalStorageData();
        
        // 動画の準備完了を待つ
        console.log('動画の準備完了を待機中...');
        
        // 各動画の準備完了を監視
        setupVideoReadyListeners();
        
        // フォールバック: 15秒で強制的に開始（Android対応で延長）
        setTimeout(() => {
          if (videoReadyCount < totalVideos) {
            console.log('動画準備タイムアウト、強制的に開始します');
            startVideoSequenceAfterReady();
          }
        }, 15000);
        
      } catch (error) {
        console.error("ページ読み込みエラー:", error);
        // エラー時はデフォルトで進行
        setTimeout(() => {
          proceedToCosmos();
        }, 2000);
      }
    });
    
    // ローディング画面を非表示
    function hideLoadingScreen() {
      const loadingScreen = document.getElementById('loadingScreen');
      loadingScreen.style.opacity = '0';
      setTimeout(() => {
        loadingScreen.style.display = 'none';
      }, 200);
    }
    
    // 動画シーケンス開始
    function startVideoSequence() {
      console.log('動画シーケンス開始');
      
      // 1.mp4を表示・再生
      showVideo('video1', () => {
        console.log('video1完了');
        
        // 2.mp4を表示・再生（重なり合うように）
        showOverlappingVideo('video2', () => {
          console.log('video2完了');
          
          // 3.mp4を表示・再生（重なり合うように）
          showOverlappingVideo('video3', () => {
            console.log('video3完了');
            
            // 最終画像（4.png）を表示
            showFinalImage();
            
            // ritual-cosmos.htmlに遷移
            setTimeout(() => {
              proceedToCosmos();
            }, 2000);
          });
        });
      });
    }
    
    // 個別動画を表示・再生（最初の動画用）
    function showVideo(videoId, onComplete) {
      const video = document.getElementById(videoId);
      
      if (!video) {
        console.error(`動画が見つかりません: ${videoId}`);
        if (onComplete) onComplete();
        return;
      }
      
      // 動画の読み込みを確認
      if (video.readyState < 1) {
        console.log(`${videoId} の読み込みを待機中...`);
        video.addEventListener('canplay', () => {
          playVideo(videoId, video, onComplete);
        }, { once: true });
        return;
      }
      
      playVideo(videoId, video, onComplete);
    }
    
    function playVideo(videoId, video, onComplete) {
      // 動画を滑らかにフェードイン
      video.classList.add('fade-in');
      
      // 動画を再生（iPhone対応）
      const playPromise = video.play();
      if (playPromise !== undefined) {
        playPromise.then(() => {
          console.log(`${videoId} 再生開始（滑らかなフェードイン）`);
          
          // アニメーション完了後にshowクラスを追加
          setTimeout(() => {
            video.classList.remove('fade-in');
            video.classList.add('show');
          }, 1000);
        
        // 動画終了時にコールバック実行
        video.addEventListener('ended', () => {
          console.log(`${videoId} 再生完了`);
          
          // 滑らかにフェードアウト
          video.classList.remove('show');
          video.classList.add('fade-out');
          
          // フェードアウト完了後に非表示
          setTimeout(() => {
            video.classList.remove('fade-out');
            video.style.opacity = '0';
          }, 1000);
          
          // コールバック実行
          if (onComplete) onComplete();
        }, { once: true });
        
        }).catch(error => {
          console.error(`${videoId} 再生エラー:`, error);
          video.classList.remove('fade-in');
          if (onComplete) onComplete();
        });
      }
    }
    
    // 滑らかなクロスフェード動画を表示・再生
    function showOverlappingVideo(videoId, onComplete) {
      const video = document.getElementById(videoId);
      
      if (!video) {
        console.error(`動画が見つかりません: ${videoId}`);
        if (onComplete) onComplete();
        return;
      }
      
      // 動画の読み込みを確認
      if (video.readyState < 1) {
        console.log(`${videoId} の読み込みを待機中...`);
        video.addEventListener('canplay', () => {
          playOverlappingVideo(videoId, video, onComplete);
        }, { once: true });
        return;
      }
      
      playOverlappingVideo(videoId, video, onComplete);
    }
    
    function playOverlappingVideo(videoId, video, onComplete) {
      // 動画を滑らかにフェードイン
      video.classList.add('fade-in');
      
      // Android対応: 動画の読み込み状態を再確認
      if (video.readyState < 2) {
        console.log(`${videoId} の読み込みを待機中...`);
        video.addEventListener('loadeddata', () => {
          startVideoPlayback(videoId, video, onComplete);
        }, { once: true });
        return;
      }
      
      startVideoPlayback(videoId, video, onComplete);
    }
    
    function startVideoPlayback(videoId, video, onComplete) {
      // 動画を再生（Android対応）
      const playPromise = video.play();
      if (playPromise !== undefined) {
        playPromise.then(() => {
          console.log(`${videoId} 再生開始（滑らかなクロスフェード）`);
          
          // アニメーション完了後にshowクラスを追加
          setTimeout(() => {
            video.classList.remove('fade-in');
            video.classList.add('show');
          }, 1000);
        
        // 動画終了時にコールバック実行
        video.addEventListener('ended', () => {
          console.log(`${videoId} 再生完了`);
          
          // コールバックを即座に実行（次の動画を開始）
          if (onComplete) onComplete();
          
          // 前の動画を滑らかにフェードアウト
          setTimeout(() => {
            video.classList.remove('show');
            video.classList.add('fade-out');
            
            setTimeout(() => {
              video.classList.remove('fade-out');
              video.style.opacity = '0';
            }, 1000);
          }, 500);
        }, { once: true });
        
        }).catch(error => {
          console.error(`${videoId} 再生エラー:`, error);
          video.classList.remove('fade-in');
          if (onComplete) onComplete();
        });
      }
    }
    
    // 最終画像（4.png）を表示
    function showFinalImage() {
      const finalImage = document.getElementById('finalImage');
      
      if (!finalImage) {
        console.error('最終画像が見つかりません');
        return;
      }
      
      console.log('最終画像（4.png）を表示開始');
      
      // 最終画像を滑らかにフェードイン
      finalImage.classList.add('show');
    }
  </script>
</body>
</html>
