<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>鑑定結果 | AI鑑定師 龍</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover, maximum-scale=1.0, minimum-scale=1.0">
  <style>
    body {
      margin: 0;
      background: #0d0d1a;
      font-family: "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
      color: #fff;
      overflow-x: hidden;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      touch-action: pan-y;
      position: relative;
      min-height: 100vh;
      -webkit-text-size-adjust: 100%;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* cosmo2.mp4背景動画 */
    .cosmo2-background {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      z-index: -1;
      opacity: 0;
      transition: opacity 0.2s ease-in-out;
    }
    
    .cosmo2-background.show {
      opacity: 1;
    }

    .cosmo2-background.immediate-show {
      opacity: 1;
      transition: none;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      text-align: center;
    }

    /* 龍と守護神の表示スタイル */
    .dragon-reveal {
      text-align: center;
      margin-bottom: 40px;
      animation: dragonAppear 2s ease-in-out;
    }
    
    .dragon-image {
      max-width: 100px;
      height: auto;
      border-radius: 10px;
      box-shadow: 0 0 30px rgba(102, 204, 255, 0.6);
    }
    
    @keyframes dragonAppear {
      0% {
        opacity: 0;
        transform: scale(0.5) translateY(50px);
      }
      100% {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }
    
    .guardian-reveal {
      animation: guardianAppear 2s ease-in-out 0.5s both;
    }
    
    @keyframes guardianAppear {
      0% {
        opacity: 0;
        transform: scale(0.8) translateY(30px);
      }
      100% {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    .guardian {
      max-width: 180px;
      height: auto;
      border-radius: 15px;
      box-shadow: 0 0 40px rgba(157, 78, 221, 0.6);
      margin: 20px auto;
    }

    .glow-text {
      background: linear-gradient(45deg, #c77dff, #9d4edd);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-size: 1.5em;
      font-weight: bold;
      margin: 20px 0;
      position: relative;
      display: inline-block;
      padding: 8px 16px;
      border-radius: 12px;
      max-width: 100%;
      box-sizing: border-box;
    }

    /* 背景画像と重なる部分の文字に濃いグレーのぼかし背景（result内のglow-textのみ） */
    .result .glow-text::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(40, 40, 60, 0.85);
      border-radius: 12px;
      backdrop-filter: blur(8px);
      z-index: -1;
    }

    .result {
      display: none;
      padding: 40px 20px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 20px;
      margin: 20px 0;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }


    .guardian-message-btn {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 15px 30px;
      background: linear-gradient(45deg, #9d4edd, #c77dff);
      border: none;
      border-radius: 25px;
      color: #fff;
      font-size: 1.1em;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      opacity: 0;
      transform: translateX(-50%) translateY(50px);
      z-index: 2500;
    }

    .guardian-message-btn.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .guardian-message-btn:hover {
      background: linear-gradient(45deg, #c77dff, #9d4edd);
      transform: translateX(-50%) translateY(-2px);
      box-shadow: 0 10px 25px rgba(157, 78, 221, 0.4);
    }

    /* フルスクリーン守護神表示 */
    .guardian-fullscreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(135deg, #0d0d1a 0%, #1a1a2e 50%, #16213e 100%);
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      z-index: 2000;
      opacity: 0;
      transition: opacity 1s ease-in-out;
      box-sizing: border-box;
    }

    .guardian-fullscreen.show {
      opacity: 1;
    }

    .guardian-fullscreen img {
      max-width: 85vw;
      max-height: 65vh;
      width: auto;
      height: auto;
      border-radius: 20px;
      box-shadow: 0 0 50px rgba(157, 78, 221, 0.8);
      margin-bottom: 25px;
      animation: float 3s ease-in-out infinite;
      object-fit: cover;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-15px); }
    }

    .guardian-fullscreen h2 {
      font-size: 1.8em;
      margin-bottom: 8px;
      margin-top: 0;
      background: linear-gradient(45deg, #c77dff, #9d4edd);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-align: center;
    }

    .guardian-fullscreen p {
      font-size: 1.1em;
      line-height: 1.4;
      max-width: 500px;
      text-align: center;
      margin: 0 0 25px 0;
      padding: 0 20px;
    }

    /* レスポンシブ対応 */
    @media (max-width: 600px) {
      .container {
        padding: 10px;
      }
      
      .guardian {
        max-width: 150px;
      }
      
      .guardian-message-btn {
        bottom: 20px;
        width: calc(100% - 40px);
        max-width: 400px;
      }
      
      .guardian-fullscreen img {
        max-width: 90vw;
        max-height: 60vh;
        margin-bottom: 20px;
      }
      
      .guardian-fullscreen h2 {
        font-size: 1.4em;
        margin-bottom: 6px;
        margin-top: 0;
      }
      
      .guardian-fullscreen p {
        font-size: 0.95em;
        line-height: 1.3;
        padding: 15px;
        margin: 0 0 20px 0;
        max-width: 90vw;
      }
      
      .result .glow-text {
        font-size: 1.3em;
        padding: 6px 12px;
        margin: 15px 10px;
      }
    }

    /* iPhone X以降のノッチ対応 */
    @supports (padding: max(0px)) {
      .guardian-message-btn {
        bottom: max(20px, env(safe-area-inset-bottom) + 10px);
      }
    }
  </style>
</head>
<body>
  <!-- cosmo2.mp4背景動画 -->
  <video id="cosmo2Background" class="cosmo2-background" autoplay muted loop>
    <source src="../photo/cosmo2.mp4" type="video/mp4">
  </video>
  
  <div class="container">
    <!-- 鑑定結果表示エリア -->
    <div class="result" id="resultBox">
      <h2 class="glow-text">あなたの守護神を伝えよう･･･</h2>
      <div id="guardian"></div>
    </div>

  </div>

  <!-- フルスクリーン守護神表示 -->
  <div class="guardian-fullscreen" id="guardianFullscreen">
    <img id="fullscreenGuardianImg" src="" alt="守護神">
    <h2 id="fullscreenGuardianName"></h2>
    <p id="fullscreenGuardianDesc"></p>
    <button id="fullscreenGuardianBtn" class="guardian-message-btn">
      守護神の言葉を聞く
    </button>
  </div>
  
  <script type="module">
    import { guardians } from '../assets/js/guardians.js';
    
    console.log('guardians.js 読み込み完了:', guardians);
    // 守護神の言葉ページに移動する関数
    function goToGuardianMessage(guardianName, zodiacSign) {
      // 十二支から守護神のキーを取得
      const guardianKey = zodiacToGuardianKey[zodiacSign];
      if (guardianKey) {
        // URLパラメータから生年月日を取得
        const urlParams = new URLSearchParams(window.location.search);
        const year = urlParams.get('year');
        const month = urlParams.get('month');
        const day = urlParams.get('day');
        
        const params = new URLSearchParams({
          guardian: guardianKey
        });
        
        // 生年月日パラメータがあれば追加
        if (year && month && day) {
          params.set('birthYear', year);
          params.set('birthMonth', month);
          params.set('birthDay', day);
        }
        
        window.location.href = `guardians.html?${params.toString()}`;
      } else {
        // フォールバック
        window.location.href = 'guardians.html';
      }
    }

    // URLパラメータから生年月日を取得する関数
    function getBirthDateFromURL() {
      const urlParams = new URLSearchParams(window.location.search);
      const year = urlParams.get('year');
      const month = urlParams.get('month');
      const day = urlParams.get('day');
      
      if (!year || !month || !day) {
        return null;
      }
      
      return {
        year: parseInt(year),
        month: parseInt(month),
        day: parseInt(day)
      };
    }

    // 十二支を計算する関数
    function getZodiac(year, month, day) {
      const zodiacSigns = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];
      const zodiacYear = year - 4;
      const zodiacIndex = zodiacYear % 12;
      const zodiac = zodiacSigns[zodiacIndex];
      return zodiac;
    }

    // 十二支から守護神キーへのマッピング
    const zodiacToGuardianKey = {
      '子': 'senju',
      '丑': 'kokuzo',
      '寅': 'kokuzo',
      '卯': 'monju',
      '辰': 'fugen',
      '巳': 'fugen',
      '午': 'seishi',
      '未': 'dainichi',
      '申': 'dainichi',
      '酉': 'fudo',
      '戌': 'amida',
      '亥': 'yakushi'
    };

    // フルスクリーン表示の処理を簡素化
    function showFullscreenGuardian(guardian, zodiac) {
      const fullscreenImg = document.getElementById('fullscreenGuardianImg');
      const fullscreenName = document.getElementById('fullscreenGuardianName');
      const fullscreenDesc = document.getElementById('fullscreenGuardianDesc');
      const fullscreenContainer = document.getElementById('guardianFullscreen');
      const fullscreenBtn = document.getElementById('fullscreenGuardianBtn');
      
      if (!fullscreenImg || !fullscreenName || !fullscreenDesc || !fullscreenContainer || !fullscreenBtn) {
        return false;
      }
      
      fullscreenImg.src = guardian.image;
      fullscreenImg.onerror = function() { console.error('フルスクリーン画像読み込みエラー:', this.src); };
      fullscreenName.textContent = `そなたを守護するは ${guardian.name}`;
      fullscreenDesc.textContent = guardian.catch;
      
      // ボタンのイベントリスナーを設定
      fullscreenBtn.setAttribute('data-guardian-name', guardian.name);
      fullscreenBtn.setAttribute('data-zodiac-sign', zodiac);
      fullscreenBtn.addEventListener('click', function() {
        const name = this.getAttribute('data-guardian-name');
        const zodiacSign = this.getAttribute('data-zodiac-sign');
        goToGuardianMessage(name, zodiacSign);
      });
      
      fullscreenContainer.style.display = 'flex';
      setTimeout(() => fullscreenContainer.classList.add('show'), 10);
      
      return true;
    }

    // フルスクリーン表示を終了
    function hideFullscreenGuardian() {
      const fullscreenContainer = document.getElementById('guardianFullscreen');
      if (fullscreenContainer) {
        fullscreenContainer.classList.remove('show');
        setTimeout(() => fullscreenContainer.style.display = 'none', 1000);
      }
    }

    // 結果表示処理
    function displayResults(guardian, zodiac) {
      const guardianElement = document.getElementById("guardian");
      const resultBox = document.getElementById("resultBox");
      
      if (!guardianElement || !resultBox) {
        console.error("要素が見つかりません");
        return;
      }
      
      // 龍と守護神を表示
      guardianElement.innerHTML = `
        <div class="dragon-reveal">
          <img class="dragon-image" src="../photo/ryu.png" alt="AI鑑定師 龍" 
               onerror="console.error('龍画像読み込みエラー:', this.src);">
        </div>
        <div class="guardian-reveal" style="opacity: 0;">
          <img class="guardian" src="${guardian.image}" alt="${guardian.name}" 
               onload="console.log('守護神画像読み込み成功:', this.src); this.style.opacity = '1';" 
               onerror="console.error('守護神画像読み込みエラー:', this.src); console.log('エラー時の完全URL:', new URL(this.src, window.location.href).href); this.src = '../photo/ryu.png';">
        </div>
      `;
      
      // 結果を表示
      resultBox.style.display = "block";
      resultBox.scrollIntoView({ behavior: 'smooth' });
      
      // アニメーションシーケンス
      setTimeout(() => {
        const guardianReveal = document.querySelector('.guardian-reveal');
        const guardianImg = document.querySelector('.guardian');
        if (guardianReveal && guardianImg) {
          // 直接styleで表示（より確実）
          guardianReveal.style.opacity = '1';
          guardianReveal.style.transform = 'scale(1) translateY(0)';
          guardianImg.style.opacity = '1';
          
          // CSSアニメーションも適用
          guardianReveal.style.animation = 'guardianAppear 2s ease-in-out 0.5s both';
        } else {
          console.error("守護神要素が見つかりません");
        }
        
        // フルスクリーン表示
        setTimeout(() => {
          if (showFullscreenGuardian(guardian, zodiac)) {
            setTimeout(() => {
              const fullscreenBtn = document.getElementById('fullscreenGuardianBtn');
              if (fullscreenBtn) {
                setTimeout(() => fullscreenBtn.classList.add('show'), 100);
              }
            }, 2000);
          }
        }, 2000);
      }, 2000);
    }


    // メイン処理
    function startProcess() {
      console.log('=== kekka.html デバッグ開始 ===');
      console.log('現在のURL:', window.location.href);
      console.log('URLパラメータ:', window.location.search);
      
      const birthDate = getBirthDateFromURL();
      console.log('取得された生年月日:', birthDate);
      
      if (!birthDate) {
        console.error('生年月日のパラメータが無効です');
        alert('生年月日のパラメータが無効です。');
        return;
      }
      
      // cosmo2.mp4背景動画を表示
      const cosmo2Video = document.getElementById("cosmo2Background");
      if (cosmo2Video) {
        // guardian-animation.htmlから連続再生のための時間を取得
        const urlParams = new URLSearchParams(window.location.search);
        const cosmo2Time = urlParams.get('cosmo2Time');
        
        if (cosmo2Time && !isNaN(parseFloat(cosmo2Time))) {
          console.log('Resuming cosmo2.mp4 from time:', cosmo2Time);
          // 連続再生の場合は即座に表示（遷移時間なし）
          cosmo2Video.classList.add("immediate-show");
          // 動画が読み込まれてから時間を設定
          cosmo2Video.addEventListener('loadedmetadata', () => {
            cosmo2Video.currentTime = parseFloat(cosmo2Time);
          });
        } else {
          console.log('Starting cosmo2.mp4 from beginning');
          cosmo2Video.classList.add("show");
        }
        cosmo2Video.play().catch(error => {
          console.error('cosmo2.mp4 play failed:', error);
        });
      }

      // 直接結果表示（アニメーションを削除して即座に表示）
      try {
        // 十二支を計算
        const zodiac = getZodiac(birthDate.year, birthDate.month, birthDate.day);
        console.log('計算された十二支:', zodiac);
        
        const guardianKey = zodiacToGuardianKey[zodiac];
        console.log('守護神キー:', guardianKey);
        
        console.log('guardians オブジェクト:', guardians);
        console.log('利用可能なキー:', Object.keys(guardians));
        
        const guardian = guardians[guardianKey];
        console.log('取得された守護神:', guardian);
        
        if (!guardian) {
          console.error('守護神データが見つかりません。guardianKey:', guardianKey);
          throw new Error("守護神データが見つかりません");
        }
        
        // 結果表示
        displayResults(guardian, zodiac);
        
      } catch (error) {
        console.error("鑑定処理エラー:", error);
        alert("鑑定処理中にエラーが発生しました。ページを再読み込みしてください。");
      }
    }

    // ページ読み込み時に即座にcosmo2背景を確認
    document.addEventListener("DOMContentLoaded", () => {
      const urlParams = new URLSearchParams(window.location.search);
      const cosmo2Time = urlParams.get('cosmo2Time');
      
      // 連続再生の場合は即座に背景を表示
      if (cosmo2Time && !isNaN(parseFloat(cosmo2Time))) {
        const cosmo2Video = document.getElementById("cosmo2Background");
        if (cosmo2Video) {
          cosmo2Video.classList.add("immediate-show");
          console.log('Pre-setting cosmo2 background for seamless transition');
        }
      }
      
      startProcess();
    });
  </script>
</body>
</html>